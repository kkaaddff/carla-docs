# 安装与部署

> **引用文件**
> **本文档中引用的文件**

- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/README.md)
- [CarlaSetup.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/CarlaSetup.sh)
- [CarlaSetup.bat](https://github.com/carla-simulator/carla/blob/ue5-dev/CarlaSetup.bat)
- [CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/CMakeLists.txt)
- [Options.cmake](https://github.com/carla-simulator/carla/blob/ue5-dev/CMake/Options.cmake)
- [Dependencies.cmake](https://github.com/carla-simulator/carla/blob/ue5-dev/CMake/Dependencies.cmake)
- [Toolchain.cmake](https://github.com/carla-simulator/carla/blob/ue5-dev/CMake/Toolchain.cmake)
- [build_carla.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_carla.md)
- [build_linux_ue5.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_linux_ue5.md)
- [build_windows_ue5.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_windows_ue5.md)
- [build_docker.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_docker.md)
- [start_quickstart.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_quickstart.md)
- [InstallPrerequisites.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/SetupUtils/InstallPrerequisites.sh)
- [InstallPrerequisites.bat](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/SetupUtils/InstallPrerequisites.bat)
- [Release.Dockerfile](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/Docker/Release.Dockerfile)

## 目录

1. [系统要求与先决条件](#系统要求与先决条件)
2. [使用 CarlaSetup 脚本进行环境配置](#使用carlasetup脚本进行环境配置)
3. [通过 CMake 进行编译流程](#通过cmake进行编译流程)
4. [Docker 部署选项](#docker部署选项)
5. [快速入门指南](#快速入门指南)
6. [部署选项权衡与选择](#部署选项权衡与选择)

## 系统要求与先决条件

在开始安装和部署 CARLA 仿真器之前，必须满足特定的系统要求和先决条件。这些要求确保仿真器能够稳定运行并提供高质量的自动驾驶研究环境。

根据文档，CARLA 的 Unreal Engine 5.5 版本对操作系统有严格要求。Linux 用户必须使用 Ubuntu 22.04 或更高版本，而 Windows 用户则需要 Windows 11。不支持 Ubuntu 20.04 或 Windows 10 及更低版本。这一要求是由于 Unreal Engine 5.5 的底层依赖和图形渲染需求所决定的。

推荐的硬件配置包括：Intel i7（第 9-11 代）或更高、AMD Ryzen 7 或更高处理器；至少 32GB 的 RAM；NVIDIA RTX 3070/3080/3090 或更好的显卡，且显存至少为 16GB。充足的磁盘空间也是必需的，CARLA 需要约 130GB 的硬盘或 SSD 空间来存储仿真数据和资源。

软件先决条件包括：

- **Python**：CARLA 使用 Python 作为主要脚本语言，支持 Python 3。
- **Pip**：Python 包管理器，需要版本 20.3 或更高。
- **两个 TCP 端口**：默认为 2000 和 2001，必须确保这些端口未被防火墙或其他应用程序阻塞。
- **GPU 驱动程序**：对于 Linux，需要 NVIDIA RTX 驱动程序 550 或更高版本；对于 Windows，则需要 560 或更高版本。

此外，还需要安装一些 Python 依赖项，如`pygame`和`numpy`，这些可以通过 pip 命令轻松安装。

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/README.md#L22-L31" target="_blank">README.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_quickstart.md#L14-L33" target="_blank">start_quickstart.md</a>

## 使用 CarlaSetup 脚本进行环境配置

CarlaSetup 脚本是自动化环境配置的核心工具，它简化了在 Linux 和 Windows 平台上设置 CARLA 开发环境的复杂过程。该脚本负责安装所有必要的依赖项、下载并构建 Unreal Engine 5.5，以及配置 CARLA 项目。

### Linux 环境配置

在 Linux 系统上，使用`CarlaSetup.sh`脚本进行环境配置。首先，克隆 CARLA 仓库的`ue5-dev`分支：

```sh
git clone -b ue5-dev https://github.com/carla-simulator/carla.git CarlaUE5
```

进入项目目录后，运行交互式设置脚本：

```sh
cd CarlaUE5
./CarlaSetup.sh --interactive
```

该脚本会提示输入 sudo 密码以安装系统级依赖项，并要求提供 GitHub 凭据以授权下载 CARLA 专用的 Unreal Engine 5.5 仓库。脚本会自动处理以下任务：

1.  **安装先决条件**：通过`apt`安装`build-essential`、`ninja-build`、`libvulkan1`等必要的系统包。
2.  **安装 Python**：默认使用`apt`安装 Python 3，但可以通过`--python-root=PATH`参数指定现有的 Python 安装路径。
3.  **下载并构建 Unreal Engine**：从`CarlaUnreal/UnrealEngine`仓库克隆并构建 Unreal Engine 5.5。
4.  **下载 CARLA 内容**：从 Bitbucket 下载包含地图和资产的`carla-content`仓库。
5.  **配置和构建 CARLA**：使用 CMake 配置项目，然后进行编译和安装 Python API。

对于无人值守的自动化部署，可以将 GitHub 凭据存储在环境变量中：

```sh
export GIT_LOCAL_CREDENTIALS=username@github_token
sudo -E ./CarlaSetup.sh
```

### Windows 环境配置

在 Windows 系统上，使用`CarlaSetup.bat`批处理文件。配置过程与 Linux 类似，但涉及不同的工具链：

```sh
cd CarlaUE5
CarlaSetup.bat
```

该脚本会自动执行以下操作：

1.  **安装 Visual Studio 2022**：如果未找到，脚本会下载并安装包含必要组件的 Visual Studio Community 版本。
2.  **安装 Ninja 构建系统**：用于加速 CMake 构建过程。
3.  **安装 Python**：默认安装 Python 3.8.10，但可以指定现有安装。
4.  **激活开发环境**：自动调用`vcvars64.bat`来设置 Visual Studio 的编译环境。
5.  **下载和构建 Unreal Engine**：与 Linux 流程相同，但使用`msbuild`进行编译。

**重要注意事项**：

- 必须将 GitHub 账户与 Epic Games 账户关联，才能访问 CARLA 专用的 Unreal Engine 仓库。
- 建议在运行脚本前，确保`CARLA_UNREAL_ENGINE_PATH`环境变量已正确设置，以避免重复下载和构建耗时的 Unreal Engine。
- Windows 的开发者模式必须处于激活状态，否则构建过程会失败。

**Section sources**

- [CarlaSetup.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/CarlaSetup.sh)
- [CarlaSetup.bat](https://github.com/carla-simulator/carla/blob/ue5-dev/CarlaSetup.bat)
- [InstallPrerequisites.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/SetupUtils/InstallPrerequisites.sh)
- [InstallPrerequisites.bat](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/SetupUtils/InstallPrerequisites.bat)
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/README.md#L92-L138" target="_blank">README.md</a>

## 通过 CMake 进行编译流程

CMake 是 CARLA 项目的核心构建系统，负责管理从源代码到可执行文件的整个编译过程。了解 CMake 的配置和构建流程对于自定义和调试 CARLA 至关重要。

### CMake 配置

在完成环境设置后，后续的构建操作都通过 CMake 命令执行。配置步骤使用`cmake`命令生成构建系统文件（如 Ninja 构建文件）。

**Linux 配置命令**：

```sh
cmake -G Ninja -S . -B Build --toolchain=$PWD/CMake/Toolchain.cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_ROS2=ON
```

**Windows 配置命令**：

```sh
cmake -G Ninja -S . -B Build --toolchain=$PWD/CMake/Toolchain.cmake -DCMAKE_BUILD_TYPE=Release
```

命令参数解释：

- `-G Ninja`：指定使用 Ninja 作为生成器，它比传统的 Make 更快。
- `-S .`：指定源代码目录为当前目录。
- `-B Build`：指定构建目录为`Build`。
- `--toolchain`：指定工具链文件，该文件为 Linux 平台配置了 Unreal Engine 的专用编译器（clang）和库路径。
- `-DCMAKE_BUILD_TYPE=Release`：设置构建类型为发布版，以获得最佳性能。
- `-DENABLE_ROS2=ON`：启用 ROS2 集成（仅限 Linux）。

如果需要针对特定的 Python 安装，应添加`-DPython_ROOT_DIR=PATH`和`-DPython3_ROOT_DIR=PATH`参数。

### 构建与安装

配置完成后，使用以下命令进行构建：

```sh
cmake --build Build
```

此命令会编译 CARLA 服务器、客户端和所有相关库。构建成功后，需要安装 Python API 以便在外部脚本中使用：

```sh
cmake --build Build --target carla-python-api-install
```

### 启动与打包

- **启动编辑器**：`cmake --build Build --target launch` 将启动 Unreal Editor，用于开发和调试。
- **构建包**：`cmake --build Build --target package` 会创建一个可分发的 CARLA 包，该包包含预编译的服务器和客户端，适合部署到生产环境。

### 构建预设

为了管理不同的构建配置（如 Debug、Development、Release），CARLA 提供了 CMake 预设。例如，使用`Linux-Release`预设：

```sh
cmake --preset Linux-Release
cmake --build Build/Linux-Release/ --target launch
```

这有助于在不同开发阶段（开发、测试、生产）之间快速切换。

**Section sources**

- [CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/CMakeLists.txt)
- [Options.cmake](https://github.com/carla-simulator/carla/blob/ue5-dev/CMake/Options.cmake)
- [Toolchain.cmake](https://github.com/carla-simulator/carla/blob/ue5-dev/CMake/Toolchain.cmake)
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_linux_ue5.md#L76-L244" target="_blank">build_linux_ue5.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_windows_ue5.md#L37-L117" target="_blank">build_windows_ue5.md</a>

## Docker 部署选项

Docker 为 CARLA 提供了轻量级、可移植的部署方案，特别适用于云服务（如 AWS、Azure、Google Cloud）或需要在无显示环境（headless）下运行的场景。

### Docker 镜像构建

CARLA 提供了一个`Release.Dockerfile`，用于构建生产环境的 Docker 镜像。该 Dockerfile 基于 Ubuntu 22.04，并安装了运行 CARLA 所需的核心依赖项，如`libsdl2-2.0`、`xserver-xorg`和`libvulkan1`。

```Dockerfile
ARG UBUNTU_DISTRO="22.04"
FROM ubuntu:${UBUNTU_DISTRO}

RUN packages='libsdl2-2.0 xserver-xorg libvulkan1 libomp5' \
    && apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y $packages \
    && rm -rf /var/lib/apt/lists/*
```

构建镜像的命令如下：

```sh
docker build -t carla-simulator/carla:latest .
```

### 运行 Docker 镜像

在运行 Docker 镜像前，必须安装 NVIDIA Container Toolkit，以便容器可以访问主机的 GPU。

**在无显示模式下运行**（推荐用于服务器）：

```sh
docker run \
    --runtime=nvidia \
    --net=host \
    --env=NVIDIA_VISIBLE_DEVICES=all \
    --env=NVIDIA_DRIVER_CAPABILITIES=all \
    carlasim/carla:0.10.0 bash CarlaUnreal.sh -RenderOffScreen -nosound
```

**在有显示模式下运行**（用于本地开发）：

```sh
docker run \
    --runtime=nvidia \
    --net=host \
    --user=$(id -u):$(id -g) \
    --env=DISPLAY=$DISPLAY \
    --env=NVIDIA_VISIBLE_DEVICES=all \
    --env=NVIDIA_DRIVER_CAPABILITIES=all \
    --volume="/tmp/.X11-unix:/tmp/.X11-unix:rw" \
    carlasim/carla:0.10.0 bash CarlaUnreal.sh -nosound
```

### 使用预构建镜像

对于快速启动，可以直接从 Docker Hub 拉取官方镜像：

```sh
docker pull carlasim/carla:0.10.0
```

然后使用上述命令运行。

**Section sources**

- [Release.Dockerfile](https://github.com/carla-simulator/carla/blob/ue5-dev/Util/Docker/Release.Dockerfile)
- [build_docker.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_docker.md)
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_quickstart.md#L114-L151" target="_blank">start_quickstart.md</a>

## 快速入门指南

本指南为初学者提供了一个从零开始运行 CARLA 的逐步流程。

### 步骤 1：下载预编译包

访问[CARLA GitHub 发布页面](https://github.com/carla-simulator/carla/releases)，下载最新的`.tar.gz`包。解压后，目录结构包含`CarlaUnreal.sh`（Linux）或`CarlaUnreal.exe`（Windows）启动脚本。

### 步骤 2：安装 Python 客户端

进入`PythonAPI/dist/`目录，使用 pip 安装 wheel 文件：

```sh
pip3 install carla-*.whl
```

### 步骤 3：启动 CARLA 服务器

在终端中运行：

```sh
# Linux
./CarlaUnreal.sh

# Windows
CarlaUnreal.exe
```

这将启动一个包含 Town 10 视图的窗口。

### 步骤 4：运行示例脚本

打开两个终端，一个用于生成交通，另一个用于手动控制车辆：

```sh
# 终端A：生成交通
cd PythonAPI/examples
python3 generate_traffic.py

# 终端B：手动控制
python3 manual_control.py
```

### 故障排除

- **端口被占用**：确保 2000 和 2001 端口空闲。
- **GPU 驱动问题**：检查 NVIDIA 驱动版本是否符合要求。
- **权限问题**：在 Linux 上，确保已正确配置 Docker 的无 sudo 权限。

**Section sources**

- [start_quickstart.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_quickstart.md)

## 部署选项权衡与选择

选择合适的部署方案取决于具体使用场景。

| 部署选项        | 优点                                  | 缺点                     | 适用场景                     |
| :-------------- | :------------------------------------ | :----------------------- | :--------------------------- |
| **预编译包**    | 简单、快速，无需编译                  | 无法修改源代码，功能固定 | 快速原型设计、教学演示       |
| **从源码构建**  | 可完全自定义，支持 Unreal Editor 开发 | 构建时间长，依赖复杂     | 功能开发、地图编辑、研究实验 |
| **Docker 部署** | 环境隔离，易于在云上扩展              | 需要额外的 GPU 驱动配置  | 生产环境、集群部署、CI/CD    |

**建议**：

- **初学者**：从预编译包开始，快速体验 CARLA。
- **开发者**：使用`CarlaSetup`脚本从源码构建，以获得最大的灵活性。
- **生产环境**：采用 Docker 部署，确保环境一致性和可扩展性。

**Section sources**

- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/README.md)
- [build_carla.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/build_carla.md)
- [start_quickstart.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_quickstart.md)
