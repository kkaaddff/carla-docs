# 消息订阅系统

> **引用文件**
> **本文引用的文件**

- [CarlaEgoVehicleControlSubscriber.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.h)
- [CarlaEgoVehicleControlSubscriber.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp)
- [CarlaSubscriberListener.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.h)
- [CarlaSubscriberListener.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp)
- [CarlaEgoVehicleControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h)
- [CarlaEgoVehicleControlPubSubTypes.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp)
- [VehicleControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h)
- [ros2_native.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md)
- [ros2_native.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py)
- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md)

## 目录

1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能与实时性考量](#性能与实时性考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录：扩展与定制指南](#附录扩展与定制指南)

## 简介

本文件面向使用 ROS2 与 CARLA 进行车辆控制交互的开发者，系统化阐述“控制命令订阅系统”的设计与实现，重点覆盖：

- 控制命令的接收与处理流程（油门、刹车、转向等）
- 消息反序列化与错误处理策略
- 基于 ros2_native.py 示例的订阅者客户端实现模式
- 回调函数设计与实时性、可靠性保障
- 如何扩展订阅者系统以支持新控制模式或自定义消息类型

## 项目结构

围绕 ROS2 控制订阅系统的关键代码位于以下模块：

- 订阅者实现：LibCarla/source/carla/ros2/subscribers
- 监听器回调：LibCarla/source/carla/ros2/listeners
- 消息类型与序列化：LibCarla/source/carla/ros2/types
- 控制数据模型：LibCarla/source/carla/rpc
- 文档与示例：Docs 与 PythonAPI/examples

```mermaid
graph TB
subgraph "订阅端(C++)"
A["CarlaEgoVehicleControlSubscriber<br/>订阅者"]
B["CarlaSubscriberListener<br/>监听器回调"]
T["CarlaEgoVehicleControl<br/>消息类型"]
P["CarlaEgoVehicleControlPubSubTypes<br/>序列化/反序列化"]
VC["VehicleControl<br/>控制数据模型"]
end
subgraph "发布端(Python)"
PY["ros2_native.py<br/>示例客户端"]
DOC["ros2_native.md<br/>接口说明"]
end
PY --> DOC
A --> B
B --> VC
A --> T
T --> P
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py#L1-L132" target="_blank">ros2_native.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md#L33-L64" target="_blank">ros2_native.md</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.h#L18-L45" target="_blank">CarlaEgoVehicleControlSubscriber.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md#L33-L64" target="_blank">ros2_native.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py#L1-L132" target="_blank">ros2_native.py</a>

## 核心组件

- CarlaEgoVehicleControlSubscriber：负责创建 FastDDS 订阅端，注册主题与类型，接收消息并通过监听器转发到上层。
- CarlaSubscriberListener：FastDDS DataReaderListener 实现，从 DataReader 取出样本并映射为 VehicleControl 对象，触发 ForwardMessage。
- CarlaEgoVehicleControl：ROS2 消息类型，包含 throttle、steer、brake、hand_brake、reverse、gear、manual_gear_shift 等字段。
- CarlaEgoVehicleControlPubSubTypes：提供序列化/反序列化逻辑，支撑消息在 DDS 网络中的传输。
- VehicleControl：CARLA 内部控制数据结构，用于后续应用到具体 Actor。

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.h#L18-L45" target="_blank">CarlaEgoVehicleControlSubscriber.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L154-L174" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>

## 架构总览

下图展示了从 ROS2 网络到 CARLA 控制执行的端到端路径。

```mermaid
sequenceDiagram
participant Pub as "发布者(ROS2)"
participant DDS as "FastDDS<br/>DomainParticipant/Subscriber/DataReader"
participant Sub as "CarlaEgoVehicleControlSubscriber"
participant Lsn as "CarlaSubscriberListener"
participant VC as "VehicleControl"
Pub->>DDS : 发布 CarlaEgoVehicleControl 消息
DDS->>Sub : 通过DataReader分发样本
Sub->>Lsn : 触发 on_data_available 回调
Lsn->>Lsn : 反序列化为 CarlaEgoVehicleControl
Lsn->>VC : 映射字段为 VehicleControl
Lsn->>Sub : ForwardMessage(VehicleControl)
Sub->>Sub : 标记 HasNewMessage=true
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L92-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>

## 详细组件分析

### CarlaEgoVehicleControlSubscriber：订阅者生命周期与初始化

- 初始化流程
  - 创建 DomainParticipant、注册 TypeSupport、创建 Subscriber 与 Topic
  - 创建 DataReader 并绑定 CarlaSubscriberListener
- 关键方法
  - Init：完成上述初始化并返回成功状态
  - Read：尝试从 DataReader 取出下一个样本（返回码分支处理）
  - GetMessage/HasNewMessage/IsAlive：线程安全地暴露最新控制指令
  - ForwardMessage：由监听器调用，将 VehicleControl 写入内部缓存并标记新消息
- 资源管理
  - 析构时依次删除 DataReader、Subscriber、Topic 与 DomainParticipant

```mermaid
classDiagram
class CarlaEgoVehicleControlSubscriber {
+Init() bool
+Read() bool
+HasNewMessage() bool
+IsAlive() bool
+GetMessage() VehicleControl
+GetVehicle() void*
-ForwardMessage(VehicleControl)
-DestroySubscriber()
}
class CarlaSubscriberListener {
+SetOwner(owner)
}
CarlaEgoVehicleControlSubscriber --> CarlaSubscriberListener : "持有并绑定"
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.h#L18-L45" target="_blank">CarlaEgoVehicleControlSubscriber.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.h#L15-L27" target="_blank">CarlaSubscriberListener.h</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L154-L174" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L180-L203" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>

### CarlaSubscriberListener：回调与消息反序列化

- on_data_available
  - 从 DataReader 取出样本，若返回码为 OK 则进行反序列化
  - 将 CarlaEgoVehicleControl 的各字段映射到 VehicleControl
  - 调用 ForwardMessage 将控制指令传递给订阅者
- 错误处理
  - 对所有 ReturnCode 进行分支处理并输出错误信息
- 连接状态
  - on_subscription_matched：跟踪匹配数量变化，当无匹配时销毁订阅者

```mermaid
flowchart TD
Start(["回调入口"]) --> Take["take_next_sample 成功?"]
Take --> |是| Map["映射字段到 VehicleControl"]
Map --> Forward["ForwardMessage(control)"]
Forward --> End(["结束"])
Take --> |否| Err["根据ReturnCode输出错误日志"] --> End
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L31-L45" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>

### 消息类型与反序列化：CarlaEgoVehicleControl 与 PubSubTypes

- 字段定义
  - 包含 header、throttle、steer、brake、hand_brake、reverse、gear、manual_gear_shift
- 序列化/反序列化
  - PubSubType 提供 serialize/deserialize、getSerializedSizeProvider、createData/deleteData
  - 反序列化时从 payload 中读取字节流并填充 CarlaEgoVehicleControl 对象

```mermaid
classDiagram
class CarlaEgoVehicleControl {
+header()
+throttle()
+steer()
+brake()
+hand_brake()
+reverse()
+gear()
+manual_gear_shift()
+serialize(cdr)
+deserialize(cdr)
}
class CarlaEgoVehicleControlPubSubType {
+serialize(payload, data) bool
+deserialize(payload, data) bool
+getSerializedSizeProvider(data)
+createData() void*
+deleteData(data)
}
CarlaEgoVehicleControlPubSubType --> CarlaEgoVehicleControl : "序列化/反序列化"
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L59-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>

### 控制数据模型：VehicleControl

- 字段含义
  - throttle、steer、brake：标量控制值
  - hand_brake、reverse、manual_gear_shift：布尔开关
  - gear：档位整数
- 用途
  - 作为订阅者内部的统一控制载体，供后续应用到具体 Actor

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>

### ros2_native.py 示例：订阅者客户端实现模式

- 示例目标
  - 展示如何在 CARLA 世界中启用同步模式、生成传感器、启用 ROS 并运行循环
- 关键点
  - 同步模式与固定时间步长设置
  - 传感器启用 ROS：sensor.enable_for_ros()
  - 主循环中 world.tick()推进仿真
- 与订阅系统的关联
  - 当 ego 车辆 spawn 且 ros_name 配置后，会自动创建对应主题的订阅者（/carla/{ros_name}/vehicle_control_cmd）

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py#L66-L116" target="_blank">ros2_native.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md#L33-L64" target="_blank">ros2_native.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md#L1-L41" target="_blank">README.md</a>

## 依赖关系分析

- 订阅者对监听器的依赖：订阅者持有监听器实例，并在初始化时绑定
- 监听器对消息类型的依赖：监听器直接操作 CarlaEgoVehicleControl 对象
- 订阅者对消息类型的依赖：订阅者注册 TypeSupport 并创建 DataReader
- 反序列化依赖：PubSubType 负责序列化/反序列化
- 控制应用依赖：VehicleControl 作为中间数据结构

```mermaid
graph LR
Sub["CarlaEgoVehicleControlSubscriber"] --> Lsn["CarlaSubscriberListener"]
Lsn --> Msg["CarlaEgoVehicleControl"]
Sub --> Type["CarlaEgoVehicleControlPubSubType"]
Lsn --> VC["VehicleControl"]
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L41-L47" target="_blank">VehicleControl.h</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>

## 性能与实时性考量

- 实时性保障
  - 使用同步模式与固定时间步长，确保控制指令在 tick 周期内被消费
  - 监听器回调在 DataReader 可用时立即处理，避免阻塞主线程
- 可靠性策略
  - 对 DataReader 返回码进行全面分支处理，及时发现并记录异常
  - 连接状态监控：当无匹配发布者时主动销毁订阅者，避免悬挂资源
- 数据一致性
  - 通过 HasNewMessage/GetMessage 的原子性访问，避免竞态条件
  - ForwardMessage 仅在反序列化成功后更新控制指令

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L92-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L31-L45" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py#L79-L104" target="_blank">ros2_native.py</a>

## 故障排查指南

- 常见问题与定位
  - 无法创建 DomainParticipant/Subscriber/Topic/DataReader：检查初始化返回值与错误日志
  - 反序列化失败：确认消息类型与序列化版本一致；检查 PubSubType 的 serialize/deserialize 实现
  - 无数据：确认主题名称与命名空间是否正确（/carla/{ros_name}/vehicle_control_cmd）
  - 连接断开：on_subscription_matched 检测到匹配计数归零时会销毁订阅者
- 建议排查步骤
  - 在监听器回调中打印 ReturnCode，定位具体失败原因
  - 确认发布端已安装并正确配置 ros-carla-msgs 包
  - 验证 ego 车辆 ros_name 属性与主题命名一致

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/subscribers/CarlaEgoVehicleControlSubscriber.cpp#L45-L120" target="_blank">CarlaEgoVehicleControlSubscriber.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/listeners/CarlaSubscriberListener.cpp#L47-L101" target="_blank">CarlaSubscriberListener.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md#L33-L64" target="_blank">ros2_native.md</a>

## 结论

该订阅者系统以 FastDDS 为基础，通过监听器回调将 ROS2 消息反序列化为统一的 VehicleControl 对象，并提供 HasNewMessage/GetMessage 等接口，满足实时性与可靠性的要求。结合 ros2_native.py 示例，开发者可快速搭建控制链路，并按需扩展以支持新的控制模式或自定义消息类型。

## 附录：扩展与定制指南

- 扩展控制模式
  - 新增消息字段：在 CarlaEgoVehicleControl 中添加字段，并在 PubSubType 中完善序列化/反序列化
  - 映射到新控制结构：在监听器回调中新增字段映射，或引入新的中间结构
- 自定义消息类型
  - 定义 IDL 消息并在编译阶段生成类型支持
  - 在订阅者中注册新类型并创建对应 DataReader
- 与示例集成
  - 参考 ros2_native.py 的同步模式与 tick 循环，确保控制指令在仿真步进中被消费
  - 通过 ros2_native.md 的接口说明，校验主题命名与字段范围

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControl.h#L154-L285" target="_blank">CarlaEgoVehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/types/CarlaEgoVehicleControlPubSubTypes.cpp#L82-L131" target="_blank">CarlaEgoVehicleControlPubSubTypes.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md#L33-L64" target="_blank">ros2_native.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py#L66-L116" target="_blank">ros2_native.py</a>
