# 行人动画与骨架控制

> **引用文件**
> **本文档中引用的文件**

- [WalkerAnim.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h)
- [WalkerAnim.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.cpp)
- [WalkerController.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h)
- [WalkerController.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp)
- [WalkerBoneControlIn.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlIn.h)
- [WalkerBoneControlOut.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlOut.h)
- [WalkerBoneControlIn.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WalkerBoneControlIn.h)
- [WalkerBoneControlOut.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WalkerBoneControlOut.h)
- [tuto_G_control_walker_skeletons.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md)
- [tuto_G_pedestrian_bones.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md)

## 目录

1. [简介](#简介)
2. [行人动画系统架构](#行人动画系统架构)
3. [WalkerAnim 类详解](#walkeranim类详解)
4. [骨架控制接口](#骨架控制接口)
5. [动画状态管理](#动画状态管理)
6. [动画与物理模拟协调](#动画与物理模拟协调)
7. [高级动画技术](#高级动画技术)
8. [代码示例与使用方法](#代码示例与使用方法)
9. [故障排除指南](#故障排除指南)
10. [结论](#结论)

## 简介

本文档详细介绍了 CARLA 仿真平台中的行人动画与骨架控制系统。系统基于 Unreal Engine 的动画系统实现，提供了对行人角色的精细控制能力，包括基本动画状态管理和精确的骨骼变换控制。文档将深入解析 WalkerAnim 类如何实现行人的动画播放和过渡，以及如何通过 WalkerBoneControlIn/Out 结构体实现对行人骨骼的精确控制。

## 行人动画系统架构

```mermaid
graph TB
subgraph "Python API"
Client[Python客户端]
WalkerControl[WalkerControl]
WalkerBoneControlIn[WalkerBoneControlIn]
end
subgraph "LibCarla"
RPC[RPC通信]
WalkerControlRPC[WalkerControl]
WalkerBoneControlInRPC[WalkerBoneControlIn]
WalkerBoneControlOutRPC[WalkerBoneControlOut]
end
subgraph "Unreal Engine"
WalkerController[AWalkerController]
WalkerAnim[UWalkerAnim]
SkeletalMesh[USkeletalMeshComponent]
end
Client --> RPC
WalkerControl --> RPC
WalkerBoneControlIn --> RPC
RPC --> WalkerController
WalkerController --> WalkerAnim
WalkerController --> SkeletalMesh
WalkerAnim --> SkeletalMesh
style WalkerAnim fill:#f9f,stroke:#333
style WalkerController fill:#f9f,stroke:#333
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L24-L68" target="_blank">WalkerController.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L15-L27" target="_blank">WalkerAnim.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlIn.h#L11-L18" target="_blank">WalkerBoneControlIn.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlOut.h#L11-L27" target="_blank">WalkerBoneControlOut.h</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L1-L69" target="_blank">WalkerController.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L1-L29" target="_blank">WalkerAnim.h</a>

## WalkerAnim 类详解

```mermaid
classDiagram
class UWalkerAnim {
+float Blend
+FPoseSnapshot Snap
}
UWalkerAnim --|> UAnimInstance : 继承
UAnimInstance --> USkeletalMeshComponent : 被使用
class FPoseSnapshot {
+TArray<FName> BoneNames
+TArray<FTransform> LocalTransforms
}
UWalkerAnim --> FPoseSnapshot : 包含
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L15-L27" target="_blank">WalkerAnim.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L72-L73" target="_blank">WalkerController.cpp</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L1-L29" target="_blank">WalkerAnim.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.cpp#L1-L8" target="_blank">WalkerAnim.cpp</a>

## 骨架控制接口

```mermaid
classDiagram
class FWalkerBoneControlIn {
+TMap<FString, FTransform> BoneTransforms
}
class FWalkerBoneControlOut {
+TMap<FString, FWalkerBoneControlOutData> BoneTransforms
}
class FWalkerBoneControlOutData {
+FTransform World
+FTransform Component
+FTransform Relative
}
FWalkerBoneControlOut --> FWalkerBoneControlOutData : 包含
AWalkerController --> FWalkerBoneControlIn : 设置骨骼变换
AWalkerController --> FWalkerBoneControlOut : 获取骨骼变换
AWalkerController --> FWalkerBoneControlOutData : 使用
style FWalkerBoneControlIn fill : #e6f3ff,stroke : #0066cc
style FWalkerBoneControlOut fill : #e6f3ff,stroke : #0066cc
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlIn.h#L11-L18" target="_blank">WalkerBoneControlIn.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlOut.h#L11-L27" target="_blank">WalkerBoneControlOut.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L54-L57" target="_blank">WalkerController.h</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlIn.h#L1-L20" target="_blank">WalkerBoneControlIn.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerBoneControlOut.h#L1-L29" target="_blank">WalkerBoneControlOut.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L55-L87" target="_blank">WalkerController.cpp</a>

## 动画状态管理

```mermaid
stateDiagram-v2
[*] --> 站立
站立 --> 行走 : 速度 > 0
站立 --> 奔跑 : 速度 > 行走阈值
行走 --> 站立 : 速度 = 0
行走 --> 奔跑 : 速度 > 奔跑阈值
奔跑 --> 行走 : 速度 < 奔跑阈值
奔跑 --> 站立 : 速度 = 0
站立 --> 跳跃 : 跳跃指令
行走 --> 跳跃 : 跳跃指令
奔跑 --> 跳跃 : 跳跃指令
跳跃 --> 站立 : 落地
跳跃 --> 行走 : 落地且速度 > 0
跳跃 --> 奔跑 : 落地且速度 > 奔跑阈值
note right of 站立
Blend = 0.0
end note
note right of 行走
Blend = 0.5
end note
note right of 奔跑
Blend = 1.0
end note
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L60" target="_blank">WalkerController.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L24" target="_blank">WalkerAnim.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L131-L149" target="_blank">WalkerController.cpp</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L131-L149" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L24" target="_blank">WalkerAnim.h</a>

## 动画与物理模拟协调

```mermaid
sequenceDiagram
participant Python as Python客户端
participant LibCarla as LibCarla
participant UE4 as Unreal Engine
participant Physics as 物理引擎
Python->>LibCarla : apply_control(WalkerControl)
LibCarla->>UE4 : RPC调用
UE4->>UE4 : AWalkerController : : ApplyWalkerControl()
UE4->>UE4 : 更新Control成员变量
UE4->>UE4 : AWalkerController : : Tick()
UE4->>Physics : AddMovementInput()
Physics->>UE4 : 处理物理移动
UE4->>UE4 : 更新动画状态
UE4->>UE4 : 根据速度更新Blend值
alt 骨骼控制
Python->>LibCarla : apply_control(WalkerBoneControlIn)
LibCarla->>UE4 : RPC调用
UE4->>UE4 : AWalkerController : : SetBonesTransform()
UE4->>UE4 : 更新WalkerAnim : : Snap
UE4->>UE4 : 骨骼变换生效
end
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L50-L53" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L179-L184" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L90-L129" target="_blank">WalkerController.cpp</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L50-L186" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L24" target="_blank">WalkerAnim.h</a>

## 高级动画技术

```mermaid
flowchart TD
Start([开始]) --> AnimationType{"动画类型?"}
AnimationType --> |预设动画| PresetAnimation["使用行走/奔跑/站立动画"]
AnimationType --> |自定义动画| CustomAnimation["使用骨骼控制"]
CustomAnimation --> BoneControlMethod{"控制方法?"}
BoneControlMethod --> |单帧设置| SingleFrame["调用SetBonesTransform"]
BoneControlMethod --> |连续动画| ContinuousAnimation["每帧调用SetBonesTransform"]
ContinuousAnimation --> AnimationData{"数据来源?"}
AnimationData --> |手动定义| ManualData["代码中定义变换"]
AnimationData --> |动作捕捉| MocapData["导入动作捕捉数据"]
AnimationData --> |算法生成| Algorithmic["算法生成变换"]
SingleFrame --> ApplyTransform["应用骨骼变换"]
ManualData --> ApplyTransform
MocapData --> ApplyTransform
Algorithmic --> ApplyTransform
ApplyTransform --> UpdateSnap["更新WalkerAnim::Snap"]
UpdateSnap --> Render["渲染新姿态"]
Render --> End([结束])
style PresetAnimation fill:#d4edda,stroke:#28a745
style CustomAnimation fill:#d1ecf1,stroke:#0c5460
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L90-L129" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md#L129-L137" target="_blank">tuto_G_control_walker_skeletons.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerAnim.h#L27" target="_blank">WalkerAnim.h</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md#L1-L149" target="_blank">tuto_G_control_walker_skeletons.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L90-L129" target="_blank">WalkerController.cpp</a>

## 代码示例与使用方法

```mermaid
flowchart LR
A[连接模拟器] --> B[生成行人]
B --> C{控制类型}
C --> |基本移动| D[设置WalkerControl]
C --> |骨骼控制| E[设置WalkerBoneControlIn]
D --> F[应用控制]
E --> F
F --> G[更新模拟]
G --> H{继续控制?}
H --> |是| C
H --> |否| I[清理]
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md#L10-L12" target="_blank">tuto_G_control_walker_skeletons.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L45" target="_blank">WalkerController.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.h#L57" target="_blank">WalkerController.h</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md#L1-L149" target="_blank">tuto_G_control_walker_skeletons.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md#L148-L152" target="_blank">tuto_G_pedestrian_bones.md</a>

## 故障排除指南

```mermaid
flowchart TD
Problem{"问题类型?"}
Problem --> |动画不播放| AnimationIssue["检查Blend值是否正确设置"]
Problem --> |骨骼不响应| BoneIssue["检查骨骼名称是否正确"]
Problem --> |移动不正常| MovementIssue["检查速度值是否在合理范围"]
Problem --> |控制无响应| ControlIssue["检查apply_control是否被正确调用"]
AnimationIssue --> CheckBlend["验证WalkerAnim::Blend值"]
BoneIssue --> CheckNames["验证骨骼名称拼写"]
MovementIssue --> CheckSpeed["验证速度值(0-1)"]
ControlIssue --> CheckCall["验证控制调用频率"]
CheckBlend --> Solution1["确保调用BlendPose()"]
CheckNames --> Solution2["参考skeleton.txt文件"]
CheckSpeed --> Solution3["确保速度在0-1范围内"]
CheckCall --> Solution4["确保每帧调用apply_control"]
Solution1 --> Success
Solution2 --> Success
Solution3 --> Success
Solution4 --> Success
Success([问题解决])
```

**图示来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L131-L149" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Walker/WalkerController.cpp#L90-L129" target="_blank">WalkerController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md#L150" target="_blank">tuto_G_pedestrian_bones.md</a>

**本节来源**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_walker_skeletons.md#L1-L149" target="_blank">tuto_G_control_walker_skeletons.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md#L1-L152" target="_blank">tuto_G_pedestrian_bones.md</a>

## 结论

CARLA 的行人动画与骨架控制系统提供了一套完整的解决方案，用于创建高保真的行人行为模拟。通过 WalkerAnim 类和相关的控制接口，用户可以精确控制行人的动画状态和骨骼姿态。系统设计充分考虑了动画与物理模拟的协调，确保了行人行为的自然性和真实性。对于初学者，系统提供了简单的动画状态管理；对于高级用户，则支持复杂的骨骼控制和自定义动画，满足不同层次的需求。
