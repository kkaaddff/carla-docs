# 行人行为管理


**本文档中引用的文件**   
- [WalkerAIController.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/WalkerAIController.h)
- [WalkerAIController.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/WalkerAIController.cpp)
- [WalkerManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.h)
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp)
- [WalkerEvent.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.h)
- [WalkerEvent.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.cpp)
- [Navigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.h)
- [Navigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.cpp)
- [WalkerNavigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/detail/WalkerNavigation.h)
- [WalkerNavigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/detail/WalkerNavigation.cpp)
- [generate_traffic.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/generate_traffic.py)
- [tuto_G_pedestrian_bones.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md)


## 目录
1. [引言](#引言)
2. [核心组件](#核心组件)
3. [行人AI决策系统](#行人ai决策系统)
4. [行为树结构与决策逻辑](#行为树结构与决策逻辑)
5. [行人行为控制机制](#行人行为控制机制)
6. [交通管理系统集成](#交通管理系统集成)
7. [性能优化策略](#性能优化策略)
8. [基础与高级应用](#基础与高级应用)
9. [结论](#结论)

## 引言
CARLA仿真器提供了一套完整的行人行为管理系统，用于模拟真实世界中行人的智能行为。该系统通过WalkerAIController实现行人的路径规划、障碍物避让、交通信号遵守以及与其他交通参与者的互动。本文档将深入探讨行人AI决策系统和行为控制机制，详细解释行人行为树的结构和决策逻辑，并提供配置行人行为参数的具体方法。

## 核心组件

行人行为管理系统由多个核心组件构成，包括WalkerAIController、Navigation、WalkerManager和WalkerEvent等。这些组件协同工作，实现了行人的智能行为模拟。

**Section sources**
- [WalkerAIController.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/WalkerAIController.h#L17-L34)
- [Navigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.h#L57-L156)
- [WalkerManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.h#L45-L96)

## 行人AI决策系统

行人AI决策系统基于Recast & Detour导航库实现，通过Navigation类管理行人的路径规划和运动控制。系统首先加载地图的导航数据，然后为每个行人创建导航代理，并设置目标点进行路径规划。

```mermaid
classDiagram
class Navigation {
+Load(filename) bool
+Load(content) bool
+GetPath(from, to, filter, path, area) bool
+GetAgentRoute(id, from, to, path, area) bool
+SetSimulator(simulator) void
+SetSeed(seed) void
+CreateCrowd() void
+AddWalker(id, from) bool
+AddOrUpdateVehicle(vehicle) bool
+RemoveAgent(id) bool
+UpdateVehicles(vehicles) bool
+SetWalkerMaxSpeed(id, max_speed) bool
+SetWalkerTarget(id, to) bool
+SetWalkerDirectTarget(id, to) bool
+GetWalkerTransform(id, trans) bool
+GetWalkerPosition(id, location) bool
+GetWalkerSpeed(id) float
+UpdateCrowd(state) void
+GetRandomLocation(location, filter) bool
+SetPedestriansCrossFactor(percentage) void
+PauseAgent(id, pause) void
+HasVehicleNear(id, distance, direction) bool
+SetWalkerLookAt(id, location) bool
+IsWalkerAlive(id, alive) bool
}
class WalkerManager {
+SetNav(nav) void
+SetSimulator(simulator) void
+AddWalker(id) bool
+RemoveWalker(id) bool
+Update(delta) bool
+SetWalkerRoute(id) bool
+SetWalkerRoute(id, to) bool
+SetWalkerNextPoint(id) bool
+GetWalkerNextPoint(id, location) bool
+GetWalkerCrosswalkEnd(id, location) bool
+GetTrafficLightAffecting(UnrealPos, max_distance) TrafficLight
}
class WalkerEventVisitor {
+operator()(WalkerEventIgnore) EventResult
+operator()(WalkerEventWait) EventResult
+operator()(WalkerEventStopAndCheck) EventResult
}
Navigation --> WalkerManager : "包含"
WalkerManager --> WalkerEventVisitor : "使用"
```

**Diagram sources **
- [Navigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.h#L57-L156)
- [WalkerManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.h#L45-L96)
- [WalkerEvent.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.h#L58-L67)

**Section sources**
- [Navigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.h#L57-L156)
- [WalkerManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.h#L45-L96)
- [WalkerEvent.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.h#L58-L67)

## 行为树结构与决策逻辑

行人行为树通过WalkerManager和WalkerEvent实现复杂的决策逻辑。系统将行人的路径分解为一系列带有事件的路由点，每个事件代表特定的行为模式。

```mermaid
flowchart TD
Start([开始]) --> CheckState["检查行人状态"]
CheckState --> Idle{"状态: 空闲?"}
Idle --> |是| SetRoute["设置新路线"]
Idle --> |否| Walking{"状态: 行走?"}
Walking --> |是| CheckDistance["检查到目标点距离"]
CheckDistance --> Near{"距离 ≤ 1?"}
Near --> |是| InEvent["进入事件状态"]
Near --> |否| ContinueWalking["继续行走"]
InEvent --> ExecuteEvent["执行事件"]
ExecuteEvent --> EventResult{"事件结果"}
EventResult --> |继续| ContinueEvent["继续执行事件"]
EventResult --> |结束| NextPoint["设置下一个点"]
EventResult --> |超时| NewRoute["设置新路线"]
NextPoint --> CheckEnd["检查路线结束"]
CheckEnd --> |否| Walking
CheckEnd --> |是| Stop["停止"]
Stop --> Idle
```

**Diagram sources **
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L60-L110)
- [WalkerEvent.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.cpp#L15-L63)

**Section sources**
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L60-L110)
- [WalkerEvent.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.cpp#L15-L63)

### 行人状态管理

行人状态由WalkerState枚举定义，包括空闲、行走、事件中和停止四种状态。系统根据当前状态执行相应的逻辑。

```mermaid
stateDiagram-v2
[*] --> WALKER_IDLE
WALKER_IDLE --> WALKER_WALKING : "设置路线"
WALKER_WALKING --> WALKER_IN_EVENT : "到达目标点"
WALKER_IN_EVENT --> WALKER_WALKING : "事件结束"
WALKER_IN_EVENT --> WALKER_IDLE : "事件超时"
WALKER_WALKING --> WALKER_STOP : "路线结束"
WALKER_STOP --> WALKER_IDLE : "重置"
```

**Diagram sources **
- [WalkerManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.h#L23-L28)

### 事件类型与处理

行人行为系统支持多种事件类型，包括忽略、等待和停止检查。这些事件通过std::variant实现多态行为。

```mermaid
classDiagram
class WalkerEventIgnore {
}
class WalkerEventWait {
+time : double
}
class WalkerEventStopAndCheck {
+time : double
+check_for_trafficlight : bool
+actor : TrafficLight
}
class WalkerEventVisitor {
+operator()(WalkerEventIgnore) EventResult
+operator()(WalkerEventWait) EventResult
+operator()(WalkerEventStopAndCheck) EventResult
}
WalkerEventVisitor --> WalkerEventIgnore : "处理"
WalkerEventVisitor --> WalkerEventWait : "处理"
WalkerEventVisitor --> WalkerEventStopAndCheck : "处理"
```

**Diagram sources **
- [WalkerEvent.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.h#L34-L55)
- [WalkerEvent.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.cpp#L15-L63)

## 行人行为控制机制

行人行为控制机制通过WalkerAIController实现，提供了启动、停止、设置目标位置和最大速度等接口。

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "WalkerAIController"
participant Episode as "Episode"
participant Navigation as "Navigation"
participant WalkerManager as "WalkerManager"
Client->>Controller : Start()
Controller->>Episode : RegisterAIController()
Controller->>Navigation : AddWalker()
Controller->>Episode : SetActorSimulatePhysics(false)
Controller->>Episode : SetActorCollisions(false)
Client->>Controller : GoToLocation(destination)
Controller->>Navigation : SetWalkerTarget()
Navigation->>WalkerManager : SetWalkerRoute()
WalkerManager->>Navigation : GetAgentRoute()
WalkerManager->>Navigation : SetWalkerDirectTarget()
Client->>Controller : SetMaxSpeed(max_speed)
Controller->>Navigation : SetWalkerMaxSpeed()
Client->>Controller : Stop()
Controller->>Episode : UnregisterAIController()
Controller->>Navigation : RemoveWalker()
```

**Diagram sources **
- [WalkerAIController.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/WalkerAIController.cpp#L18-L67)
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L114-L181)

**Section sources**
- [WalkerAIController.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/WalkerAIController.cpp#L18-L67)
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L114-L181)

### 路径规划与区域类型

系统根据不同的区域类型（人行道、道路、斑马线等）规划路径，并在不同区域执行相应的行为。

```mermaid
erDiagram
NAV_AREAS {
int CARLA_AREA_BLOCK PK
int CARLA_AREA_SIDEWALK
int CARLA_AREA_CROSSWALK
int CARLA_AREA_ROAD
int CARLA_AREA_GRASS
}
SAMPLE_POLY_FLAGS {
int CARLA_TYPE_NONE PK
int CARLA_TYPE_SIDEWALK
int CARLA_TYPE_CROSSWALK
int CARLA_TYPE_ROAD
int CARLA_TYPE_GRASS
int CARLA_TYPE_ALL
int CARLA_TYPE_WALKABLE
}
WALKER_ROUTE_POINT {
WalkerEvent event PK
Location location
unsigned char areaType
}
NAV_AREAS ||--o{ WALKER_ROUTE_POINT : "定义"
SAMPLE_POLY_FLAGS ||--o{ WALKER_ROUTE_POINT : "过滤"
```

**Diagram sources **
- [Navigation.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.h#L26-L44)
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L158-L174)

### 交通信号遵守

行人系统能够检测并遵守交通信号灯，确保在红灯时停止，在绿灯或黄灯时通过。

```mermaid
flowchart TD
Start([开始]) --> CheckTrafficLight["检查交通信号灯"]
CheckTrafficLight --> HasLight{"有信号灯?"}
HasLight --> |否| CheckVehicles["检查附近车辆"]
HasLight --> |是| GetState["获取信号灯状态"]
GetState --> IsGreen{"状态: 绿色或黄色?"}
IsGreen --> |是| CheckVehicles
IsGreen --> |否| Wait["等待"]
Wait --> Timeout{"超时?"}
Timeout --> |是| ResetRoute["重置路线"]
Timeout --> |否| ContinueWait["继续等待"]
CheckVehicles --> HasVehicle{"有车辆接近?"}
HasVehicle --> |是| Wait
HasVehicle --> |否| Cross["通过"]
Cross --> End([结束])
```

**Diagram sources **
- [WalkerEvent.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerEvent.cpp#L28-L62)
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L304-L324)

## 交通管理系统集成

行人行为管理系统与交通管理系统紧密集成，能够响应交通信号灯、避让车辆，并在复杂交通环境中安全移动。

```mermaid
graph TB
subgraph "行人系统"
Controller[AI控制器]
Navigation[导航系统]
Manager[行为管理器]
end
subgraph "交通环境"
TrafficLight[交通信号灯]
Vehicles[车辆]
Map[地图数据]
end
Controller --> Navigation
Navigation --> Manager
Manager --> TrafficLight
Manager --> Vehicles
Navigation --> Map
Vehicles --> Navigation
TrafficLight --> Manager
```

**Diagram sources **
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L277-L324)
- [Navigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.cpp#L708-L731)

**Section sources**
- [WalkerManager.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/WalkerManager.cpp#L277-L324)
- [Navigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.cpp#L708-L731)

## 性能优化策略

系统采用多种性能优化策略，包括异步更新、批量处理和智能资源管理，以支持大规模行人仿真。

```mermaid
flowchart TD
Start([仿真开始]) --> LoadNavMesh["加载导航网格"]
LoadNavMesh --> CreateCrowd["创建人群管理器"]
CreateCrowd --> SetFilters["设置导航过滤器"]
SetFilters --> MainLoop["主循环"]
MainLoop --> UpdateVehicles["更新车辆位置"]
UpdateVehicles --> UpdateCrowd["更新人群"]
UpdateCrowd --> ApplyStates["应用状态"]
ApplyStates --> CheckAlive["检查存活状态"]
CheckAlive --> EndFrame["结束帧"]
EndFrame --> MainLoop
CheckAlive --> RemoveDead["移除死亡行人"]
RemoveDead --> UpdateCrowd
```

**Diagram sources **
- [Navigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.cpp#L201-L264)
- [WalkerNavigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/detail/WalkerNavigation.cpp#L33-L81)

**Section sources**
- [Navigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/nav/Navigation.cpp#L201-L264)
- [WalkerNavigation.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/detail/WalkerNavigation.cpp#L33-L81)

## 基础与高级应用

### 基础应用

对于初学者，系统提供了简单的API来控制行人行为：

```mermaid
flowchart LR
Spawn[生成行人] --> CreateController[创建控制器]
CreateController --> Start[启动控制器]
Start --> SetGoal[设置目标位置]
SetGoal --> AdjustSpeed[调整速度]
AdjustSpeed --> Run[运行仿真]
```

**Section sources**
- [generate_traffic.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/generate_traffic.py#L277-L286)

### 高级应用

对于高级用户，可以自定义行为树和复杂场景：

```mermaid
flowchart TD
CustomBehavior[自定义行为] --> DefineEvents[定义事件类型]
DefineEvents --> ImplementLogic[实现决策逻辑]
ImplementLogic --> CreateScenario[创建复杂场景]
CreateScenario --> Optimize[性能优化]
Optimize --> Test[测试验证]
Test --> Deploy[部署应用]
```

**Section sources**
- [tuto_G_pedestrian_bones.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_pedestrian_bones.md#L95-L120)

## 结论
CARLA的行人行为管理系统提供了一套完整的解决方案，用于模拟真实世界中行人的智能行为。通过WalkerAIController、Navigation、WalkerManager和WalkerEvent等组件的协同工作，系统能够实现复杂的路径规划、障碍物避让、交通信号遵守和群体行走等行为模式。该系统不仅为自动驾驶研究提供了逼真的行人仿真环境，还为计算机视觉、机器人等领域的应用提供了强大的支持。