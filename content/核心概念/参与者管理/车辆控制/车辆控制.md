# 车辆控制

> **引用文件**
> **本文引用的文件**

- [LibCarla/source/carla/client/Vehicle.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h)
- [LibCarla/source/carla/client/Vehicle.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp)
- [LibCarla/source/carla/rpc/VehicleControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h)
- [LibCarla/source/carla/rpc/VehiclePhysicsControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehiclePhysicsControl.h)
- [LibCarla/source/carla/rpc/VehicleAckermannControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h)
- [LibCarla/source/carla/rpc/AckermannControllerSettings.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/AckermannControllerSettings.h)
- [LibCarla/source/carla/rpc/WheelPhysicsControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WheelPhysicsControl.h)
- [PythonAPI/examples/manual_control.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py)
- [PythonAPI/examples/automatic_control.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py)
- [PythonAPI/carla/src/Control.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp)
- [PythonAPI/carla/src/Actor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Actor.cpp)
- [Docs/tuto_G_control_vehicle_physics.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_vehicle_physics.md)
- [Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.h)
- [Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp)
- [Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/VehiclePhysicsControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/VehiclePhysicsControl.h)
- [Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp)

## 目录

1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介

本文件围绕 CARLA 的车辆控制与动力学仿真，系统性阐述 Vehicle 类作为 Actor 子类的实现机制，覆盖油门、刹车、转向、档位等控制参数配置；详解车辆物理属性（质量、轮胎摩擦、空气阻力等）的调整方式及对驾驶行为的影响；给出通过 Python/C++ API 实现车辆精确控制的方法，包括手动与自动驾驶模式切换；深入解析车辆传感器（速度计、陀螺仪）与状态反馈机制，并提供从入门到进阶的实践路径与可视化图示。

## 项目结构

- 客户端 API 与 C++实现位于 LibCarla，包含 Vehicle 类、RPC 控制数据结构与物理控制对象。
- Python 示例位于 PythonAPI/examples，演示手动控制与自动控制两种模式。
- 文档位于 Docs，提供物理参数调优与遥测可视化的指导。
- Unreal 插件中包含 Ackermann 控制器与 IMU 传感器的底层实现，支撑真实物理仿真。

```mermaid
graph TB
subgraph "客户端与Python示例"
PY_MAN["manual_control.py"]
PY_AUTO["automatic_control.py"]
end
subgraph "LibCarla(C++)"
VH["client/Vehicle.h/.cpp"]
RPC_VC["rpc/VehicleControl.h"]
RPC_VPC["rpc/VehiclePhysicsControl.h"]
RPC_WPC["rpc/WheelPhysicsControl.h"]
RPC_ACK["rpc/VehicleAckermannControl.h"]
RPC_ACKS["rpc/AckermannControllerSettings.h"]
end
subgraph "Unreal插件"
UE_ACK["Vehicle/AckermannController.(h/cpp)"]
UE_VPC["Vehicle/VehiclePhysicsControl.h"]
UE_IMU["Sensor/InertialMeasurementUnit.cpp"]
end
PY_MAN --> VH
PY_AUTO --> VH
VH --> RPC_VC
VH --> RPC_ACK
VH --> RPC_ACKS
VH --> RPC_VPC
RPC_VPC --> RPC_WPC
RPC_ACK --> UE_ACK
RPC_ACKS --> UE_ACK
VH --> UE_ACK
VH --> UE_IMU
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L1-L154" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L1-L157" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L1-L101" target="_blank">LibCarla/source/carla/rpc/VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehiclePhysicsControl.h#L1-L246" target="_blank">LibCarla/source/carla/rpc/VehiclePhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WheelPhysicsControl.h#L1-L261" target="_blank">LibCarla/source/carla/rpc/WheelPhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L1-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/AckermannControllerSettings.h#L1-L93" target="_blank">LibCarla/source/carla/rpc/AckermannControllerSettings.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L1-L219" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L1-L154" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L1-L157" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L1-L1387" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py#L1-L849" target="_blank">PythonAPI/examples/automatic_control.py</a>

## 核心组件

- Vehicle 类：继承自 Actor，提供控制接口（ApplyControl、ApplyAckermannControl）、物理控制（ApplyPhysicsControl）、灯光与车门管理、遥测开关、车轮转向方向设置与读取、失败状态查询等。
- 控制数据结构：
  - VehicleControl：包含 throttle、steer、brake、hand_brake、reverse、manual_gear_shift、gear 等字段。
  - VehicleAckermannControl：包含 steer、steer_speed、speed、acceleration、jerk 等字段。
  - AckermannControllerSettings：包含速度与加速度 PID 参数。
  - VehiclePhysicsControl：包含引擎曲线、最大扭矩、最大转速、差速器类型、前后配重、档位比、传动效率、质量、风阻系数、质心、下压力系数、惯量缩放、睡眠阈值、转向曲线、车轮数组等。
  - WheelPhysicsControl：包含轴类型、偏移、半径、宽度、质量、侧向刚度、摩擦力倍率、侧滑阈值、悬架参数、制动/手刹扭矩上限、是否受各力影响等。
- Python 绑定：在 Control.cpp 中导出 VehicleControl、VehicleAckermannControl、VehiclePhysicsControl 等对象，便于 Python 侧直接使用。
- Unreal 插件：AckermannController 实现纵向/横向控制闭环，VehiclePhysicsControl 蓝图结构用于编辑器配置；IMU 传感器输出加速度、角速度与航向。

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L32-L151" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L34-L153" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L20-L101" target="_blank">LibCarla/source/carla/rpc/VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L18-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/AckermannControllerSettings.h#L18-L93" target="_blank">LibCarla/source/carla/rpc/AckermannControllerSettings.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehiclePhysicsControl.h#L20-L246" target="_blank">LibCarla/source/carla/rpc/VehiclePhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WheelPhysicsControl.h#L19-L261" target="_blank">LibCarla/source/carla/rpc/WheelPhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L308-L323" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L472-L491" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Actor.cpp#L201-L212" target="_blank">PythonAPI/carla/src/Actor.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L1-L219" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/VehiclePhysicsControl.h#L1-L45" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/VehiclePhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>

## 架构总览

下图展示了从 Python 示例到 C++ Vehicle 接口，再到 Unreal 物理与传感器的完整链路。

```mermaid
sequenceDiagram
participant Py as "Python示例(manual_control.py)"
participant VC as "VehicleControl"
participant V as "Vehicle(C++)"
participant EP as "Episode(内部)"
participant UE as "Unreal物理/Ackermann/IMU"
Py->>VC : 构造/更新控制参数
Py->>V : apply_control(VC) 或 apply_ackermann_control(...)
V->>EP : ApplyControlToVehicle / ApplyAckermannControlToVehicle
EP->>UE : 更新物理状态(引擎/差速/轮胎/悬架)
UE-->>V : 返回最新状态(控制、灯光、速度限制等)
V-->>Py : get_control()/get_light_state()/get_speed_limit()
Py->>UE : 启用/关闭遥测(show_debug_telemetry)
UE-->>Py : 可视化指标(加速度/角速度/航向)
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L108" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L52-L120" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L581-L610" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L80-L115" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>

## 详细组件分析

### Vehicle 类与 Actor 子类关系

- 继承关系：Vehicle 继承自 Actor，复用 Actor 的生命周期与快照机制，同时扩展车辆专属控制与状态查询。
- 关键能力：
  - 控制下发：ApplyControl、ApplyAckermannControl、ApplyPhysicsControl。
  - 状态查询：GetControl、GetPhysicsControl、GetLightState、GetSpeedLimit、IsAtTrafficLight、GetTrafficLight 等。
  - 遥测：ShowDebugTelemetry。
  - 车轮：SetWheelSteerDirection、GetWheelSteerAngle。
  - 其他：OpenDoor/CloseDoor、SetLightState、EnableCarSim、UseCarSimRoad、EnableChronoPhysics、GetFailureState。

```mermaid
classDiagram
class Actor {
+get_world()
+get_transform()
+get_velocity()
+get_acceleration()
+enable_debug_telemetry(enabled)
}
class Vehicle {
+ApplyControl(control)
+ApplyAckermannControl(ackermann)
+ApplyPhysicsControl(physics)
+SetAutopilot(enabled, port)
+ShowDebugTelemetry(enabled)
+SetWheelSteerDirection(loc, angle)
+GetWheelSteerAngle(loc)
+GetControl()
+GetPhysicsControl()
+GetLightState()
+GetSpeedLimit()
+IsAtTrafficLight()
+GetTrafficLight()
+OpenDoor(door)
+CloseDoor(door)
+SetLightState(state)
+EnableCarSim(path)
+UseCarSimRoad(enabled)
+EnableChronoPhysics(...)
+GetFailureState()
}
Actor <|-- Vehicle
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L32-L151" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L34-L153" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L32-L151" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L34-L153" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>

### 控制参数与接口

- VehicleControl 字段含义：
  - throttle：油门比例(0~1)。
  - steer：前轮转向角(弧度，经 Get/SetWheelSteerAngle 映射)。
  - brake：制动比例(0~1)。
  - hand_brake：手刹。
  - reverse：倒车档。
  - manual_gear_shift：手动换挡。
  - gear：当前档位(-1 为倒车，0 为空挡，正数为前进档)。
- ApplyControl 与 ApplyAckermannControl：
  - ApplyControl 直接下发给物理引擎。
  - ApplyAckermannControl 以目标速度/加速度/转向速率等进行闭环控制，适合自动驾驶或更平滑的人工驾驶体验。
- AckermannControllerSettings：
  - 包含速度与加速度的 PID 参数，用于调节响应速度与稳定性。

```mermaid
flowchart TD
Start(["开始"]) --> Mode{"选择控制模式"}
Mode --> |手动| VC["构造VehicleControl<br/>设置throttle/steer/brake等"]
Mode --> |Ackermann| ACK["构造VehicleAckermannControl<br/>设置steer/speed/acceleration/jerk"]
VC --> Apply["Vehicle.ApplyControl(...)"]
ACK --> ApplyAck["Vehicle.ApplyAckermannControl(...)"]
Apply --> Sync["Episode同步到物理引擎"]
ApplyAck --> Sync
Sync --> Readback["Vehicle.GetControl()<br/>获取最新控制"]
Readback --> End(["结束"])
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L20-L101" target="_blank">LibCarla/source/carla/rpc/VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L18-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L68" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L308-L323" target="_blank">PythonAPI/carla/src/Control.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L20-L101" target="_blank">LibCarla/source/carla/rpc/VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L18-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L68" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L308-L323" target="_blank">PythonAPI/carla/src/Control.cpp</a>

### 车辆物理属性与调参

- VehiclePhysicsControl 关键项：
  - 引擎：torque_curve、max_torque、max_rpm、idle_rpm、brake_effect、rev_up_moi、rev_down_rate。
  - 传动：differential_type、front_rear_split、use_automatic_gears、gear_change_time、final_ratio、forward_gear_ratios、reverse_gear_ratios、change_up_rpm、change_down_rpm、transmission_efficiency。
  - 车身：mass、drag_coefficient、center_of_mass、chassis_width、chassis_height、downforce_coefficient、drag_area、inertia_tensor_scale、sleep_threshold、sleep_slope_limit。
  - 转向：steering_curve。
  - 轮子：wheels（每个轮子独立配置）。
  - 悬架与碰撞：use_sweep_wheel_collision。
- WheelPhysicsControl 关键项：
  - 几何与质量：offset、wheel_radius、wheel_width、wheel_mass。
  - 摩擦与侧向：cornering_stiffness、friction_force_multiplier、side_slip_modifier、slip_threshold、skid_threshold。
  - 动力学：max*steer_angle、max_brake_torque、max_hand_brake_torque、spring_rate、spring_preload、suspension*\*、rollbar_scaling 等。
  - 影响因素：是否受转向/制动/手刹/引擎影响、ABS 与牵引力控制开关等。
- 调参建议：
  - 质量与风阻：增大质量与风阻会降低加速度但提升高速稳定性；减小可提升加速性能。
  - 轮胎摩擦：提高 friction_force_multiplier 可增强抓地力，但可能引发更明显的轮胎侧滑与转向不足/过度。
  - 悬架：提高弹簧刚度与阻尼可减少车身俯仰，但可能牺牲舒适性。
  - 差速器与档位：合理设置前后配重与档位比，有助于改善起步与弯道表现。

```mermaid
classDiagram
class VehiclePhysicsControl {
+torque_curve[]
+max_torque
+max_rpm
+idle_rpm
+brake_effect
+rev_up_moi
+rev_down_rate
+differential_type
+front_rear_split
+use_automatic_gears
+gear_change_time
+final_ratio
+forward_gear_ratios[]
+reverse_gear_ratios[]
+change_up_rpm
+change_down_rpm
+transmission_efficiency
+mass
+drag_coefficient
+center_of_mass
+chassis_width
+chassis_height
+downforce_coefficient
+drag_area
+inertia_tensor_scale
+sleep_threshold
+sleep_slope_limit
+steering_curve[]
+wheels[]
+use_sweep_wheel_collision
}
class WheelPhysicsControl {
+axle_type
+offset
+wheel_radius
+wheel_width
+wheel_mass
+cornering_stiffness
+friction_force_multiplier
+side_slip_modifier
+slip_threshold
+skid_threshold
+max_steer_angle
+affected_by_steering
+affected_by_brake
+affected_by_handbrake
+affected_by_engine
+abs_enabled
+traction_control_enabled
+max_wheelspin_rotation
+external_torque_combine_method
+lateral_slip_graph[]
+suspension_axis
+suspension_force_offset
+suspension_max_raise
+suspension_max_drop
+suspension_damping_ratio
+wheel_load_ratio
+spring_rate
+spring_preload
+suspension_smoothing
+rollbar_scaling
+sweep_shape
+sweep_type
+max_brake_torque
+max_hand_brake_torque
+wheel_index
+location
+old_location
+velocity
}
VehiclePhysicsControl --> WheelPhysicsControl : "包含多个轮子"
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehiclePhysicsControl.h#L20-L246" target="_blank">LibCarla/source/carla/rpc/VehiclePhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WheelPhysicsControl.h#L19-L261" target="_blank">LibCarla/source/carla/rpc/WheelPhysicsControl.h</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehiclePhysicsControl.h#L20-L246" target="_blank">LibCarla/source/carla/rpc/VehiclePhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/WheelPhysicsControl.h#L19-L261" target="_blank">LibCarla/source/carla/rpc/WheelPhysicsControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_vehicle_physics.md#L1-L72" target="_blank">Docs/tuto_G_control_vehicle_physics.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L472-L491" target="_blank">PythonAPI/carla/src/Control.cpp</a>

### Ackermann 转向模型与控制器

- Ackermann 控制目标：
  - 通过目标转向角、转向速率、目标速度、加速度与加加速度(jerk)实现更接近真实车辆的运动学。
- 控制流程要点：
  - 转向控制：根据目标转向角与转向速率，平滑逼近当前转向角。
  - 速度/加速度控制：速度环与加速度环分别 PID 调节，输出油门/制动。
  - 倒车与驻车：在低速时优先全制动，避免抖动。
  - 输出：将计算得到的 Steer、Throttle、Brake、bReverse 写入 VehicleControl。

```mermaid
flowchart TD
S0["接收目标(VehicleAckermannControl)"] --> S1["更新目标参数(steer/speed/acceleration/jerk)"]
S1 --> S2["RunControlSteering()<br/>平滑转向角"]
S2 --> S3{"RunControlFullStop()<br/>接近静止?"}
S3 --> |是| S4["全制动"]
S3 --> |否| S5["RunControlReverse()<br/>倒车判断"]
S5 --> S6["RunControlSpeed()<br/>速度环PID"]
S6 --> S7["RunControlAcceleration()<br/>加速度环PID"]
S7 --> S8["UpdateVehicleControlCommand()<br/>生成Throttle/Brake/bReverse"]
S8 --> S9["输出VehicleControl"]
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L18-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/AckermannControllerSettings.h#L18-L93" target="_blank">LibCarla/source/carla/rpc/AckermannControllerSettings.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L80-L115" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L169-L199" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L200-L219" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L1-L219" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleAckermannControl.h#L18-L85" target="_blank">LibCarla/source/carla/rpc/VehicleAckermannControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/AckermannControllerSettings.h#L18-L93" target="_blank">LibCarla/source/carla/rpc/AckermannControllerSettings.h</a>

### 手动控制与自动驾驶模式切换

- 手动控制：
  - 使用键盘事件更新 VehicleControl，支持油门/刹车/转向/手刹/倒车/手动档位。
  - 支持切换 Ackermann 控制器，以目标速度/加速度/转向速率进行平滑控制。
- 自动驾驶模式：
  - 示例中通过 BasicAgent/ConstantVelocityAgent/BehaviorAgent 生成控制指令，再 apply_control 下发。
  - 可结合同步模式与交通管理器实现稳定仿真。

```mermaid
sequenceDiagram
participant User as "用户/键盘"
participant MC as "KeyboardControl"
participant V as "Vehicle"
participant AG as "Agent(自动)"
participant EP as "Episode"
User->>MC : 按键事件
MC->>V : apply_control(手动控制) 或 apply_ackermann_control(ACK模式)
AG->>V : run_step() -> apply_control(自动控制)
V->>EP : ApplyControlToVehicle
EP-->>V : 最新控制/状态
V-->>MC : get_control()/get_light_state()/get_speed_limit()
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L581-L610" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py#L745-L770" target="_blank">PythonAPI/examples/automatic_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L68" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L581-L610" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py#L745-L770" target="_blank">PythonAPI/examples/automatic_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L68" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>

### 传感器集成与状态反馈

- IMU 传感器：
  - 提供加速度、角速度与航向，用于姿态与动态监测。
  - Unreal 端 IMU 计算加速度与角速度并应用噪声模型，输出标准化数据。
- GNSS/GPS：
  - 提供经纬度信息，辅助定位。
- 车辆遥测：
  - 通过 Vehicle.ShowDebugTelemetry 开启，可在服务器窗口查看多维指标与参考点。
- Python 侧状态读取：
  - 通过 Vehicle.GetControl、GetLightState、GetSpeedLimit、IsAtTrafficLight 等接口获取最新状态。

```mermaid
graph LR
V["Vehicle"] -- "遥测开关" --> EP["Episode"]
V -- "状态查询" --> EP
EP -- "返回控制/灯光/限速/红绿灯状态" --> V
V -- "附加传感器" --> IMU["IMU传感器"]
IMU -- "加速度/角速度/航向" --> V
V -- "GNSS/GPS" --> GPS["GNSS传感器"]
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L94-L125" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L990-L1021" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Actor.cpp#L201-L212" target="_blank">PythonAPI/carla/src/Actor.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L990-L1021" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L94-L125" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Actor.cpp#L201-L212" target="_blank">PythonAPI/carla/src/Actor.cpp</a>

## 依赖关系分析

- Vehicle 对 RPC 数据结构的依赖：Vehicle 的所有控制与查询均基于 rpc 命名空间的数据结构。
- Python 绑定对 C++实现的依赖：Control.cpp 导出 VehicleControl、VehicleAckermannControl、VehiclePhysicsControl 等，使 Python 侧可直接实例化与使用。
- Unreal 插件对 Vehicle 与传感器的依赖：AckermannController 依赖 ACarlaWheeledVehicle 的状态与物理参数；IMU 传感器依赖 UE 物理世界提供的加速度与角速度。

```mermaid
graph TB
PY["PythonAPI(Control.cpp)"] --> RPC["rpc/Vehicle*.h"]
RPC --> VH["client/Vehicle.h/.cpp"]
VH --> UE["Unreal插件(Ackermann/IMU)"]
```

图表来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L308-L323" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L472-L491" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L32-L151" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L34-L153" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp#L1-L219" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Vehicle/AckermannController.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L308-L323" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L472-L491" target="_blank">PythonAPI/carla/src/Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.h#L32-L151" target="_blank">LibCarla/source/carla/client/Vehicle.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L34-L153" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>

## 性能考量

- 控制频率与同步模式：
  - 在同步模式下，固定步长时间(fixed_delta_seconds)可提升控制一致性与可重复性，但 CPU 占用更高。
- 物理复杂度：
  - 增加轮胎数量、启用 use_sweep_wheel_collision、复杂转向曲线与档位切换都会增加计算开销。
- 传感器数量与分辨率：
  - 提高相机/激光雷达分辨率或增加传感器数量会显著提升渲染与处理负载。
- 调参建议：
  - 对于实时交互，优先简化物理参数；对于离线仿真或研究，可逐步增加复杂度以逼近真实。

## 故障排查指南

- 控制未生效：
  - 检查是否处于异步模式且 tick 未正确推进；确认 ApplyControl/ApplyAckermannControl 调用成功。
- 车辆不动或抖动：
  - 检查手刹/驻车制动是否开启；核对摩擦力与悬架参数；适当降低转向速率与加加速度。
- 转向不自然：
  - 调整 Ackermann 控制器的 PID 参数；检查最大转向角与转向曲线。
- 遥测无显示：
  - 确认已调用 ShowDebugTelemetry(true)，并确保服务器窗口可见。
- 传感器数据异常：
  - 检查 IMU/GNSS 传感器挂载位置与朝向；确认监听回调正常触发。

章节来源

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L47-L56" target="_blank">LibCarla/source/carla/client/Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L468-L479" target="_blank">PythonAPI/examples/manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp#L140-L176" target="_blank">Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/InertialMeasurementUnit.cpp</a>

## 结论

CARLA 的车辆控制体系以 Vehicle 为核心，通过 VehicleControl 与 VehicleAckermannControl 实现灵活的人工与自动驾驶控制；借助 VehiclePhysicsControl 与 WheelPhysicsControl，用户可以精细调参以匹配不同场景需求。配合 IMU/GNSS 等传感器与遥测功能，可构建完整的感知-控制-反馈闭环。建议从简单参数入手，逐步引入 Ackermann 控制与复杂物理特性，在保证稳定性的同时探索更真实的驾驶行为。

## 附录

- 快速上手步骤（Python）：
  - 连接客户端，获取世界与车辆。
  - 修改 VehiclePhysicsControl 并 apply_physics_control。
  - 在手动模式下按键更新 VehicleControl，或切换至 Ackermann 模式。
  - 开启遥测观察指标，接入 IMU/GNSS 传感器进行状态反馈。
- 参考示例路径：
  - 手动控制：<a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L581-L610" target="_blank">manual_control.py</a>
  - 自动控制：<a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py#L745-L770" target="_blank">automatic_control.py</a>
  - 物理调参示例：<a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_G_control_vehicle_physics.md#L1-L72" target="_blank">tuto_G_control_vehicle_physics.md</a>
