# 基础车辆操作

> **引用文件**
> **本文档引用文件**

- [VehicleControl.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h)
- [Control.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp)
- [Vehicle.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp)
- [manual_control.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py)
- [automatic_control.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py)
- [foundations.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/foundations.md)
- [control.yml](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/docs/control.yml)

## 目录

1. [简介](#简介)
2. [车辆控制参数详解](#车辆控制参数详解)
3. [控制方法实现](#控制方法实现)
4. [同步与异步模式](#同步与异步模式)
5. [控制示例](#控制示例)
6. [高级控制机制](#高级控制机制)
7. [控制模式切换](#控制模式切换)

## 简介

CARLA 模拟器提供了完整的车辆控制接口，允许用户通过编程方式精确控制车辆的运动状态。本文档详细介绍了车辆的基本操作接口，包括油门、刹车、转向等控制参数的配置方法，以及在不同模式下的控制策略。

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/foundations.md#L73-L99" target="_blank">foundations.md</a>

## 车辆控制参数详解

车辆控制主要通过`VehicleControl`结构体实现，包含以下核心参数：

### 油门（throttle）

- **取值范围**：0.0 到 1.0
- **功能**：控制车辆的加速程度，0.0 表示无加速，1.0 表示最大加速
- **默认值**：0.0

### 刹车（brake）

- **取值范围**：0.0 到 1.0
- **功能**：控制车辆的制动程度，0.0 表示无制动，1.0 表示最大制动
- **默认值**：0.0

### 转向（steer）

- **取值范围**：-1.0 到 1.0
- **功能**：控制车辆的转向方向，-1.0 表示最大左转，1.0 表示最大右转，0.0 表示直行
- **默认值**：0.0

### 手刹（hand_brake）

- **取值范围**：布尔值
- **功能**：启用或禁用手刹
- **默认值**：False

### 倒档（reverse）

- **取值范围**：布尔值
- **功能**：控制车辆是否进入倒车模式
- **默认值**：False

### 手动换挡（manual_gear_shift）

- **取值范围**：布尔值
- **功能**：启用或禁用手动换挡模式
- **默认值**：False

### 挡位（gear）

- **取值范围**：整数
- **功能**：指定当前挡位，正数为前进挡，负数为倒挡
- **默认值**：0

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/VehicleControl.h#L20-L47" target="_blank">VehicleControl.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/docs/control.yml#L6-L47" target="_blank">control.yml</a>

## 控制方法实现

车辆控制通过`apply_control()`方法实现，该方法将控制指令应用到指定车辆。

### Python 代码示例

```python
# 创建车辆控制对象
control = carla.VehicleControl()
control.throttle = 0.5  # 设置50%油门
control.steer = 0.2     # 向右转向20%
control.brake = 0.0     # 无刹车
control.hand_brake = False
control.reverse = False

# 应用控制指令
vehicle.apply_control(control)
```

### C++代码示例

```cpp
// 创建车辆控制对象
carla::rpc::VehicleControl control;
control.throttle = 0.5f;  // 设置50%油门
control.steer = 0.2f;     // 向右转向20%
control.brake = 0.0f;     // 无刹车
control.hand_brake = false;
control.reverse = false;

// 应用控制指令
vehicle->ApplyControl(control);
```

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/Control.cpp#L287-L306" target="_blank">Control.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L51-L55" target="_blank">Vehicle.cpp</a>

## 同步与异步模式

CARLA 支持同步和异步两种模式，这对车辆控制有重要影响。

### 异步模式

- **特点**：服务器以最快速度运行，客户端请求即时处理
- **适用场景**：实验性设置、快速原型开发
- **配置方法**：

```python
settings = world.get_settings()
settings.synchronous_mode = False  # 禁用同步模式
world.apply_settings(settings)
```

### 同步模式

- **特点**：客户端控制服务器更新时机，提供更好的控制和可预测性
- **适用场景**：数据采集、智能体部署
- **配置方法**：

```python
settings = world.get_settings()
settings.synchronous_mode = True   # 启用同步模式
settings.fixed_delta_seconds = 0.05  # 设置固定时间步长
world.apply_settings(settings)
```

**重要提示**：启用同步模式时，如果使用交通管理器，也必须将其设置为同步模式。

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/foundations.md#L73-L99" target="_blank">foundations.md</a>

## 控制示例

### 键盘控制车辆移动

```python
class KeyboardControl:
    def __init__(self, world):
        self._control = carla.VehicleControl()
        self._steer_cache = 0.0

    def parse_keys(self, keys, milliseconds):
        # 油门控制
        self._control.throttle = 1.0 if keys[K_UP] or keys[K_w] else 0.0

        # 转向控制
        steer_increment = 5e-4 * milliseconds
        if keys[K_LEFT] or keys[K_a]:
            self._steer_cache -= steer_increment
        elif keys[K_RIGHT] or keys[K_d]:
            self._steer_cache += steer_increment
        else:
            self._steer_cache = 0.0

        self._steer_cache = max(-0.7, min(0.7, self._steer_cache))
        self._control.steer = round(self._steer_cache, 1)

        # 刹车控制
        self._control.brake = 1.0 if keys[K_DOWN] or keys[K_s] else 0.0
        self._control.hand_brake = keys[K_SPACE]

        # 应用控制
        world.player.apply_control(self._control)
```

### 自动驾驶控制

```python
# 启用自动驾驶模式
vehicle.set_autopilot(True)

# 配置交通管理器端口
vehicle.set_autopilot(True, tm_port=8000)
```

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L386-L604" target="_blank">manual_control.py</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/automatic_control.py#L1440-L1444" target="_blank">automatic_control.py</a>

## 高级控制机制

### 控制命令频率限制

在同步模式下，控制命令的频率受固定时间步长限制。建议控制频率与仿真步长匹配，通常为 20Hz（0.05 秒）。

### 插值处理

CARLA 内部对控制指令进行平滑处理，避免突然的控制变化导致不自然的车辆行为。转向控制尤其需要考虑平滑性。

### 状态同步机制

在同步模式下，必须确保客户端和服务器状态同步：

```python
# 正确的同步模式控制流程
while True:
    # 1. 等待仿真步进
    world.tick()

    # 2. 获取最新状态
    snapshot = world.get_snapshot()

    # 3. 计算控制指令
    control = calculate_control()

    # 4. 应用控制
    vehicle.apply_control(control)
```

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/sensor_synchronization.py#L94-L112" target="_blank">sensor_synchronization.py</a>

## 控制模式切换

### 手动与自动驾驶切换

```python
# 切换到自动驾驶模式
vehicle.set_autopilot(True)

# 切换回手动控制模式
vehicle.set_autopilot(False)

# 带交通管理器端口的自动驾驶
vehicle.set_autopilot(True, tm_port=8000)
```

### 最佳实践

1. **模式切换时重置控制状态**：在切换到手动控制时，重置控制变量以避免意外行为
2. **状态检查**：在应用控制前检查车辆状态
3. **平滑过渡**：在模式切换时实现平滑过渡，避免突然的速度或方向变化

```python
def switch_to_manual_control():
    # 停止自动驾驶
    vehicle.set_autopilot(False)

    # 重置控制状态
    control = carla.VehicleControl()
    control.throttle = 0.0
    control.steer = 0.0
    control.brake = 0.0

    # 应用初始控制
    vehicle.apply_control(control)
```

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Vehicle.cpp#L46-L47" target="_blank">Vehicle.cpp</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/manual_control.py#L545-L552" target="_blank">manual_control.py</a>
