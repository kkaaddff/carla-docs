# 项目概述

> **引用文件**
> **本文档引用的文件**

- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/README.md)
- [index.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/index.md)
- [start_introduction.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_introduction.md)
- [Client.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Client.h)
- [World.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/World.h)
- [TrafficManager.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/trafficmanager/TrafficManager.h)
- [ROS2.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/ROS2.h)
- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md)
- [adv_traffic_manager.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_traffic_manager.md)
- [python_api.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/python_api.md)
- [core_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/core_sensors.md)

## 目录

1. [引言](#引言)
2. [核心架构](#核心架构)
3. [主要组件](#主要组件)
4. [系统功能](#系统功能)
5. [使用场景](#使用场景)
6. [技术细节](#技术细节)
7. [结论](#结论)

## 引言

CARLA 是一个开源的自动驾驶仿真平台，专为自动驾驶研究而设计。该平台基于 Unreal Engine 5.5 构建，提供高保真的城市环境模拟，支持灵活的传感器配置和环境条件设置。CARLA 的核心目标是为自动驾驶系统的开发、训练和验证提供一个开放、可定制的工具。

CARLA 采用客户端-服务器架构，服务器负责处理仿真本身的所有计算，包括物理计算、传感器渲染和世界状态更新。客户端则通过 Python 或 C++ API 控制仿真中的参与者（actors）和环境状态。这种架构使得 CARLA 能够支持大规模的分布式仿真和测试。

CARLA 不仅提供了一个强大的仿真引擎，还构建了一个围绕主平台的生态系统，包括场景生成、交通模拟、ROS2 集成等工具。这些工具共同构成了一个完整的自动驾驶研发环境。

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/README.md#L1-L215" target="_blank">README.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_introduction.md#L1-L49" target="_blank">start_introduction.md</a>

## 核心架构

CARLA 的架构基于客户端-服务器模型，其中服务器运行在 Unreal Engine 5.5 之上，负责所有仿真相关的计算。客户端通过 API 与服务器通信，控制仿真过程。这种分离的设计允许客户端在不同的机器上运行，而服务器则可以在高性能 GPU 上运行以处理复杂的图形和物理计算。

```mermaid
graph TB
subgraph "服务器端"
UE[Unreal Engine 5.5]
Sim[仿真核心]
Physics[物理引擎]
Rendering[渲染系统]
end
subgraph "客户端"
PythonAPI[Python API]
CppAPI[C++ API]
ROS2[ROS2接口]
end
Client[客户端应用] --> PythonAPI
PythonAPI --> LibCarla[LibCarla通信库]
LibCarla <--> Server[CARLA服务器]
Server --> UE
UE --> Physics
UE --> Rendering
Sim --> Physics
Sim --> Rendering
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_introduction.md#L14-L18" target="_blank">start_introduction.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Client.h#L20-L193" target="_blank">Client.h</a>

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/start_introduction.md#L12-L18" target="_blank">start_introduction.md</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Client.h#L1-L193" target="_blank">Client.h</a>

## 主要组件

### LibCarla 通信库

LibCarla 是 CARLA 的核心通信库，它实现了客户端与服务器之间的 RPC 通信。该库提供了 C++和 Python 接口，封装了底层的网络通信细节，使开发者能够专注于仿真逻辑的实现。

```mermaid
classDiagram
class Client {
+string host
+uint16_t port
+Client(host, port)
+GetWorld() World
+GetTrafficManager(port) TrafficManager
+StartRecorder(name) string
+ReplayFile(name, start, duration, follow_id) string
+ApplyBatch(commands) void
}
class World {
+GetMap() Map
+GetBlueprintLibrary() BlueprintLibrary
+SpawnActor(blueprint, transform) Actor
+GetActors() ActorList
+WaitForTick(timeout) WorldSnapshot
+Tick(timeout) uint64_t
}
class TrafficManager {
+SetPercentageSpeedDifference(actor, percentage) void
+SetDesiredSpeed(actor, value) void
+SetGlobalDistanceToLeadingVehicle(distance) void
+SetSynchronousMode(mode) void
+SynchronousTick() bool
}
class ROS2 {
+Enable(enable) void
+ProcessDataFromCamera(sensor_type, stream_id, sensor_transform, W, H, Fov, buffer) void
+ProcessDataFromLidar(sensor_type, stream_id, sensor_transform, data) void
+ProcessDataFromIMU(sensor_type, stream_id, sensor_transform, accelerometer, gyroscope, compass) void
}
Client --> World : "获取"
Client --> TrafficManager : "获取"
Client --> ROS2 : "获取"
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Client.h#L20-L193" target="_blank">Client.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/World.h#L45-L243" target="_blank">World.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/trafficmanager/TrafficManager.h#L26-L407" target="_blank">TrafficManager.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/ROS2.h#L47-L177" target="_blank">ROS2.h</a>

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/Client.h#L1-L193" target="_blank">Client.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/client/World.h#L1-L243" target="_blank">World.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/trafficmanager/TrafficManager.h#L1-L407" target="_blank">TrafficManager.h</a>
- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/ROS2.h#L1-L177" target="_blank">ROS2.h</a>

### Python/C++ API 接口

CARLA 提供了 Python 和 C++两种 API 接口，使开发者能够以编程方式控制仿真。Python API 特别适合快速原型开发和机器学习应用，而 C++ API 则提供了更高的性能和更直接的底层访问。

API 的主要功能包括：

- 连接到 CARLA 服务器
- 加载和切换地图
- 生成和控制参与者（车辆、行人等）
- 配置和使用传感器
- 控制交通管理器
- 录制和回放仿真

### ROS2 集成模块

CARLA 原生支持 ROS2，这使得它能够无缝集成到基于 ROS2 的自动驾驶系统中。ROS2 模块负责将 CARLA 的传感器数据转换为 ROS2 消息，并将控制命令从 ROS2 节点传递到 CARLA 中的车辆。

### Unreal 引擎仿真环境

CARLA 的仿真环境基于 Unreal Engine 5.5 构建，利用其先进的图形渲染能力提供高保真的视觉效果。Unreal Engine 负责处理所有的 3D 渲染、物理模拟和场景管理。

## 系统功能

### 多传感器系统

CARLA 支持多种类型的传感器，包括摄像头、激光雷达、雷达、IMU、GNSS 等。每种传感器都可以配置不同的参数，如分辨率、视场角、更新频率等。

```mermaid
flowchart TD
A[传感器设置] --> B[选择传感器类型]
B --> C[配置传感器属性]
C --> D[创建传感器蓝图]
D --> E[在世界中生成传感器]
E --> F[将传感器附加到参与者]
F --> G[启动传感器监听]
G --> H[处理传感器数据]
H --> I[保存或可视化数据]
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/core_sensors.md#L19-L102" target="_blank">core_sensors.md</a>

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/core_sensors.md#L1-L198" target="_blank">core_sensors.md</a>

### 动态交通参与者模拟

CARLA 的交通管理器（Traffic Manager）能够控制大量自动驾驶车辆，创建逼真的城市交通环境。交通管理器可以配置各种行为参数，如速度、车距、车道变换等。

### 同步/异步模式

CARLA 支持同步和异步两种仿真模式。在同步模式下，仿真步进由客户端控制，确保了仿真的确定性和可重复性。在异步模式下，仿真以最大速度运行，适合性能测试。

```mermaid
sequenceDiagram
participant Client
participant Server
participant TM
Client->>Server : 设置同步模式
Server-->>Client : 确认
loop 每个仿真步
Client->>Server : Tick
Server->>TM : 更新交通
TM-->>Server : 返回控制命令
Server->>Server : 执行物理模拟
Server-->>Client : 返回世界快照
end
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_traffic_manager.md#L492-L518" target="_blank">adv_traffic_manager.md</a>

### 录制回放功能

CARLA 的录制功能可以记录整个仿真过程，包括所有参与者的状态、传感器数据和事件。录制的文件可以用于回放、分析和调试。

```mermaid
flowchart LR
A[开始录制] --> B[记录仿真数据]
B --> C{仿真结束?}
C --> |否| B
C --> |是| D[停止录制]
D --> E[保存录制文件]
E --> F[回放录制]
F --> G[分析仿真结果]
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#L1-L318" target="_blank">adv_recorder.md</a>

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#L1-L318" target="_blank">adv_recorder.md</a>

### 交通管理器

交通管理器是 CARLA 的核心组件之一，负责管理仿真中的交通流。它实现了多个控制阶段，包括定位、碰撞检测、交通灯处理、运动规划等。

```mermaid
graph TD
A[ALSM] --> B[车辆注册]
B --> C[仿真状态]
C --> D[控制循环]
D --> E[内存地图]
D --> F[PBVT]
D --> G[PID控制器]
D --> H[命令数组]
H --> I[应用命令]
```

**Diagram sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_traffic_manager.md#L48-L58" target="_blank">adv_traffic_manager.md</a>

**Section sources**

- <a href="https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_traffic_manager.md#L1-L548" target="_blank">adv_traffic_manager.md</a>

## 使用场景

### 感知算法训练

CARLA 可以生成大量带标注的传感器数据，用于训练感知算法。通过配置不同的传感器和环境条件，可以创建多样化的训练数据集。

### 决策规划验证

在 CARLA 中可以测试和验证自动驾驶的决策规划算法。通过创建复杂的交通场景，可以评估算法在各种情况下的表现。

### 传感器仿真测试

CARLA 的高保真传感器模型可以用于测试传感器融合算法和感知系统。通过调整传感器参数，可以模拟不同类型的传感器和故障情况。

## 技术细节

### 客户端-服务器通信

CARLA 使用高效的 RPC 机制进行客户端-服务器通信。LibCarla 库处理所有的网络通信，提供简洁的 API 接口。

### 数据流管理

CARLA 通过流式传输机制高效地传输传感器数据。不同类型的数据使用不同的传输通道，确保实时性和可靠性。

### 性能优化

CARLA 实现了多种性能优化技术，包括混合物理模式、异步传感器处理和批处理命令。

## 结论

CARLA 作为一个开源的自动驾驶仿真平台，提供了完整的工具链和生态系统。其基于 Unreal Engine 5.5 的高保真仿真能力，结合灵活的 API 和丰富的功能，使其成为自动驾驶研究的理想选择。通过本文档的介绍，开发者可以快速了解 CARLA 的核心功能和架构，开始使用该平台进行自动驾驶系统的开发和测试。
