# 创建与使用语义标签

> **引用文件**
> **本文档中引用的文件**

- [SemanticSegmentationCamera.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.h)
- [SemanticSegmentationCamera.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.cpp)
- [Tagger.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.cpp)
- [Tagger.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.h)
- [ObjectLabel.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/ObjectLabel.h)
- [CityScapesPalette.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/image/CityScapesPalette.h)
- [tuto_D_create_semantic_tags.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_D_create_semantic_tags.md)
- [ref_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_sensors.md)
- [World.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/World.cpp)

## 目录

1. [引言](#引言)
2. [语义分割传感器工作原理](#语义分割传感器工作原理)
3. [默认语义标签集](#默认语义标签集)
4. [创建自定义语义标签](#创建自定义语义标签)
5. [为自定义资产分配语义标签](#为自定义资产分配语义标签)
6. [扩展标签集以支持新类别](#扩展标签集以支持新类别)
7. [最佳实践](#最佳实践)
8. [常见问题与解决方案](#常见问题与解决方案)
9. [结论](#结论)

## 引言

语义标签系统是 CARLA 仿真平台中用于感知算法训练的关键组成部分。通过为场景中的每个物体分配语义类别，语义分割传感器能够生成带有类别信息的图像数据，这对于自动驾驶系统的计算机视觉模型训练至关重要。本文档详细介绍了如何在 CARLA 中创建和使用语义标签系统，包括语义分割传感器的工作原理、如何通过修改静态网格体材质 ID 或使用特定 Actor 标签来定义新的语义类别，以及如何验证和扩展标签系统。

**Section sources**

- [tuto_D_create_semantic_tags.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_D_create_semantic_tags.md)
- [ref_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_sensors.md)

## 语义分割传感器工作原理

语义分割传感器是一种特殊的相机传感器，它为场景中的每个像素分配一个语义标签，从而生成"语义分割"图像。在 CARLA 中，`ASemanticSegmentationCamera`类实现了这一功能，继承自`AShaderBasedSensor`基类。该传感器通过后处理材质（PostProcessing Material）来实现语义分割效果，具体使用了`GTMaterial`材质来编码物体的语义信息。

传感器的工作流程如下：在每次物理模拟周期后，通过`PostPhysTick`方法读取传感器图像数据，并将数据发送给客户端。语义信息被编码在图像的红色通道中，每个像素的红色值对应一个语义标签 ID。客户端接收到原始图像后，可以使用`carla.ColorConverter.CityScapesPalette`颜色转换器将标签 ID 转换为可视化颜色，便于查看和分析。

语义标签的重要性在于为感知算法提供精确的地面真值（ground truth）数据。在训练深度学习模型时，这些标注数据可用于监督学习，帮助模型学习识别不同类别的物体。与实例分割不同，语义分割为同一类别的所有实例分配相同的标签，而实例分割则为每个物体实例分配唯一 ID。

**Section sources**

- [SemanticSegmentationCamera.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.h)
- [SemanticSegmentationCamera.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.cpp)
- [ref_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_sensors.md)

## 默认语义标签集

CARLA 提供了一套预定义的语义标签集，涵盖了城市环境中常见的物体类别。这些标签在`ObjectLabel.h`文件中定义为`CityObjectLabel`枚举类型，每个标签都有唯一的 ID、名称和对应的颜色编码。标签系统基于 Cityscapes 数据集的标签方案，并进行了扩展以适应仿真需求。

主要的语义类别包括：建筑物（Building）、围栏（Fence）、行人（Pedestrian）、电线杆（Pole）、道路标线（RoadLine）、道路（Road）、人行道（SideWalk）、植被（Vegetation）、车辆（Vehicles）、墙体（Wall）、交通标志（TrafficSign）、天空（Sky）、地面（Ground）、桥梁（Bridge）、轨道（RailTrack）、护栏（GuardRail）、交通灯（TrafficLight）、静态物体（Static）、动态物体（Dynamic）、水域（Water）和地形（Terrain）等。

每个标签在`CityScapesPalette.h`中都有对应的颜色编码，这些颜色用于将标签 ID 转换为可视化图像。例如，建筑物标签（ID 1）对应颜色(70, 70, 70)，车辆标签（ID 10）对应颜色(0, 0, 142)。这种颜色编码方案确保了不同类别的物体在可视化图像中有明显的颜色区分。

**Section sources**

- [ObjectLabel.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/ObjectLabel.h)
- [CityScapesPalette.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/image/CityScapesPalette.h)
- [ref_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_sensors.md)

## 创建自定义语义标签

在 CARLA 中创建自定义语义标签需要修改多个文件以建立完整的标签系统。这个过程涉及在代码中定义新的标签 ID，在 Unreal Engine 中创建对应的文件夹结构，并建立代码与引擎之间的双向映射关系。

首先，需要在`LibCarla/source/carla/rpc/ObjectLabel.h`文件中为新标签添加枚举值。新标签应添加到枚举列表的末尾，遵循现有的命名格式。例如，要添加一个"Rock"（岩石）标签，可以在枚举中添加`Rock = 29u`。

其次，在 Unreal Engine 编辑器中，需要在`Carla/Static`目录下创建一个与标签同名的新文件夹。这个文件夹将用于存放所有属于该类别的静态网格体资产。虽然文件夹名称不必与标签名称完全相同，但建议保持一致以提高可维护性。

然后，需要在`Tagger.cpp`文件中建立代码标签与 Unreal Engine 文件夹之间的双向映射。在`GetLabelByFolderName`函数中添加新的条件分支，将文件夹名称映射到相应的标签枚举值。同时，在`GetTagAsString`函数中添加 switch-case 语句，将标签枚举值映射回字符串名称。

最后，需要在`CityScapesPalette.h`文件中为新标签定义颜色编码。颜色值应添加到调色板数组的相应位置，确保数组索引与标签 ID 一致。选择的颜色应与其他标签有足够区分度，避免在可视化时产生混淆。

**Section sources**

- [tuto_D_create_semantic_tags.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_D_create_semantic_tags.md)
- [ObjectLabel.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/rpc/ObjectLabel.h)
- [Tagger.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.cpp)
- [CityScapesPalette.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/image/CityScapesPalette.h)

## 为自定义资产分配语义标签

为自定义资产分配语义标签的核心机制是基于 Unreal Engine 中的文件夹路径。CARLA 的标签系统通过`ATagger::GetLabelByPath`函数根据资产的存储路径自动确定其语义类别。具体来说，系统会解析资产的完整路径，提取第五级目录名称（对于 UE5UseOnly 路径则为第六级），然后通过`GetLabelByFolderName`函数查找对应的标签。

在运行时，`ATagger::TagActor`函数负责为场景中的每个 Actor 分配语义标签。该函数会遍历 Actor 的所有静态网格体组件和骨骼网格体组件，根据其网格体资产的路径获取标签，并将标签信息存储在组件的`CustomPrimitiveDataVector4`中。同时，标签名称也会作为组件标签（Component Tag）添加到组件的`ComponentTags`数组中。

对于静态网格体，可以通过修改其材质 ID 来影响语义标签，但这不是主要的标签分配方式。更常见和推荐的方法是将网格体资产放入正确命名的文件夹中。例如，所有属于"Pedestrian"类别的网格体都应存放在`Carla/Static/Pedestrian`目录下。

验证标签分配正确性的方法是使用语义分割相机捕获图像，并检查输出结果。如果资产的语义标签正确分配，它在分割图像中应该显示为对应类别的颜色。也可以通过 Python API 查询 Actor 的标签信息来验证。

**Section sources**

- [Tagger.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.cpp)
- [Tagger.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.h)

## 扩展标签集以支持新类别

扩展 CARLA 的标签集以支持新的物体类别需要系统性的修改，确保所有相关组件都能识别和处理新标签。除了在核心代码中定义新标签外，还需要在 Python API 中进行相应的更新，以便脚本能够使用新标签。

在`PythonAPI/carla/src/World.cpp`文件中，`CityObjectLabel`枚举需要在 Python 绑定中添加新值。这通过在`enum_<cr::CityObjectLabel>("CityObjectLabel")`定义中添加`.value("NewLabel", cr::CityObjectLabel::NewLabel)`来实现。这样，Python 脚本就可以通过`carla.CityObjectLabel.NewLabel`访问新标签。

此外，如果新标签需要用于特定功能，如边界框查询过滤，还需要确保相关功能支持新类别。例如，`carla.World`的`get_level_bbs`方法可以根据`CityObjectLabel`过滤边界框，因此新标签必须正确集成到这个系统中。

在扩展标签集时，需要注意标签 ID 的连续性和预留空间。虽然标签不必按顺序排列，但保持有序有助于维护。同时，应避免使用已存在的 ID，防止标签冲突。对于未来可能添加的类别，可以预留一些 ID 范围。

**Section sources**

- [World.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/World.cpp)
- [tuto_D_create_semantic_tags.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_D_create_semantic_tags.md)

## 最佳实践

在创建和使用语义标签时，遵循最佳实践可以确保系统的稳定性和可维护性。首先，建立一致的标签命名规范非常重要。建议使用大驼峰命名法（PascalCase），如"TrafficLight"、"RoadLine"，并保持名称简洁明确。

避免标签冲突的关键是确保每个资产只属于一个语义类别。虽然 CARLA 允许一个 Actor 包含多个不同类别的组件，但每个组件应有明确的分类。例如，交通灯的灯箱部分应标记为"TrafficLight"，而支撑杆部分应标记为"Pole"。

确保标签在不同光照条件下的稳定性是另一个重要考虑因素。由于语义分割基于材质和渲染设置，而不是实际光照，因此标签在各种天气和光照条件下都应保持一致。这通过使用后处理材质来实现，而不是依赖动态光照计算。

版本控制和文档记录也是最佳实践的重要组成部分。每次添加新标签时，都应在文档中记录其用途、颜色编码和使用示例。这有助于团队成员理解和使用标签系统，减少错误和混淆。

**Section sources**

- [tuto_D_create_semantic_tags.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/tuto_D_create_semantic_tags.md)
- [ref_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_sensors.md)

## 常见问题与解决方案

在使用语义标签系统时，可能会遇到一些常见问题。标签显示异常是最常见的问题之一，通常表现为物体在分割图像中显示为黑色（未标记）或其他错误颜色。这通常是由于资产未放入正确的文件夹，或标签映射未正确配置。解决方案是检查资产路径是否与`GetLabelByFolderName`函数中的条件匹配，并验证`CityScapesPalette`数组索引是否与标签 ID 一致。

分割结果不准确可能是由于多个原因造成的。如果物体边缘出现错误标签，可能是由于网格体重叠或碰撞体设置不当。检查网格体的几何形状和碰撞体设置，确保没有不必要的重叠。如果整个物体标签错误，应检查`Tagger::TagActor`函数的执行情况，确保标签正确分配给了所有组件。

编译错误是扩展标签集时常见的问题，通常是由于头文件包含顺序或枚举值冲突引起的。确保在修改`ObjectLabel.h`后重新编译所有相关模块，并检查是否有重复的标签 ID。运行时崩溃可能与标签 ID 溢出有关，特别是当使用大于 255 的 ID 时，因为标签被存储为 uint8_t 类型。

性能问题也可能出现，特别是在场景中有大量高多边形网格体时。优化建议包括使用适当的 LOD（细节层次）设置，减少不必要的网格体复杂度，以及合理管理标签系统的更新频率。

**Section sources**

- [Tagger.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Game/Tagger.cpp)
- [SemanticSegmentationCamera.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Sensor/SemanticSegmentationCamera.cpp)

## 结论

CARLA 的语义标签系统为自动驾驶感知算法的训练提供了强大的支持。通过理解语义分割传感器的工作原理和标签分配机制，用户可以有效地创建和使用自定义语义类别。本文档详细介绍了从创建新标签到验证其正确性的完整流程，以及扩展标签集和解决常见问题的方法。

语义标签不仅是简单的分类工具，更是连接仿真环境与机器学习模型的桥梁。正确配置的标签系统可以生成高质量的训练数据，显著提高感知算法的性能。随着自动驾驶技术的发展，灵活可扩展的标签系统将变得越来越重要，支持更多样化的场景和物体类别。

通过遵循文档中描述的最佳实践，用户可以构建稳定、可靠且易于维护的语义标签系统，为自动驾驶研究和开发提供坚实的基础。
