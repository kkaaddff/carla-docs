# 插件创建


**本文档中引用的文件**  
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [Carla.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.h)
- [Carla.Build.cs](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.Build.cs)
- [CarlaSettings.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Settings/CarlaSettings.h)
- [ActorDispatcher.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/ActorDispatcher.cpp)
- [ActorDispatcher.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/ActorDispatcher.h)
- [CarlaActor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/CarlaActor.cpp)
- [CarlaTools.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaTools/Source/CarlaTools/Public/CarlaTools.h)
- [CarlaExporter.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Private/CarlaExporter.cpp)
- [CarlaExporterCommands.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Public/CarlaExporterCommands.h)


## 目录
1. [项目结构](#项目结构)
2. [Carla.uplugin文件详解](#carlauplugin文件详解)
3. [插件初始化过程](#插件初始化过程)
4. [自定义CARLA插件创建指南](#自定义carla插件创建指南)
5. [Actor类型和功能接口定义](#actor类型和功能接口定义)
6. [插件与Unreal Engine编辑器集成](#插件与unreal-engine编辑器集成)
7. [线程安全和内存管理最佳实践](#线程安全和内存管理最佳实践)

## 项目结构

CARLA插件的项目结构遵循Unreal Engine插件的标准组织方式，主要包含三个核心插件：Carla、CarlaExporter和CarlaTools。这些插件位于Unreal/CarlaUnreal/Plugins目录下，每个插件都有独立的Source目录存放C++源代码。

```mermaid
graph TD
A[Unreal/CarlaUnreal/Plugins] --> B[Carla]
A --> C[CarlaExporter]
A --> D[CarlaTools]
B --> E[Source/Carla]
C --> F[Source/CarlaExporter]
D --> G[Source/CarlaTools]
E --> H[Actor]
E --> I[Game]
E --> J[Sensor]
E --> K[Vehicle]
E --> L[Walker]
E --> M[Settings]
```

**图示来源**
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)
- [CarlaExporter.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/CarlaExporter.uplugin)
- [CarlaTools.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaTools/CarlaTools.uplugin)

**本节来源**
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)
- [CarlaExporter.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/CarlaExporter.uplugin)
- [CarlaTools.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaTools/CarlaTools.uplugin)

## Carla.uplugin文件详解

Carla.uplugin文件是CARLA插件的核心配置文件，采用JSON格式定义了插件的元数据、模块配置和依赖关系。该文件位于Unreal/CarlaUnreal/Plugins/Carla/目录下。

### 基本信息配置

Carla.uplugin文件首先定义了插件的基本信息，包括版本号、友好名称、描述和创建者信息：

- **FileVersion**: 插件文件格式版本，当前为3
- **Version**: 插件版本号，当前为1
- **VersionName**: 版本名称，如"0.10.0"
- **FriendlyName**: 插件的友好名称"CARLA"
- **Description**: 插件描述"Open-source simulator for autonomous driving research."
- **Category**: 插件分类"Science"
- **CreatedBy**: 创建者"Computer Vision Center (CVC) at the Universitat Autonoma de Barcelona (UAB)"

### 模块定义

插件的核心是模块定义部分，通过"Modules"数组配置：

```json
"Modules": [
  {
    "Name": "Carla",
    "Type": "Runtime",
    "LoadingPhase": "PreDefault",
    "AdditionalDependencies": [
      "Engine"
    ]
  }
]
```

- **Name**: 模块名称"Carla"
- **Type**: 模块类型"Runtime"，表示这是一个运行时模块
- **LoadingPhase**: 加载阶段"PreDefault"，表示在默认加载阶段之前加载
- **AdditionalDependencies**: 额外依赖项，这里依赖"Engine"模块

### 插件依赖配置

Carla.uplugin文件还通过"Plugins"数组配置了插件依赖：

```json
"Plugins": [
  {
    "Name": "ProceduralMeshComponent",
    "Enabled": true
  },
  {
    "Name": "ChaosVehiclesPlugin",
    "Enabled": true
  }
]
```

这些依赖确保了CARLA插件能够使用程序化网格组件和混沌车辆物理系统。

### 其他重要配置

- **CanContainContent**: true，表示插件可以包含内容资产
- **IsBetaVersion**: true，表示这是测试版本
- **Installed**: true，表示插件已安装

```mermaid
classDiagram
class CarlaUPlugin {
+int FileVersion
+int Version
+string VersionName
+string FriendlyName
+string Description
+string Category
+string CreatedBy
+string CreatedByURL
+string DocsURL
+string SupportURL
+bool CanContainContent
+bool IsBetaVersion
+bool Installed
}
class Module {
+string Name
+string Type
+string LoadingPhase
+array AdditionalDependencies
}
class PluginDependency {
+string Name
+bool Enabled
}
CarlaUPlugin --> Module : "contains"
CarlaUPlugin --> PluginDependency : "depends on"
```

**图示来源**
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)

**本节来源**
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)

## 插件初始化过程

CARLA插件的初始化过程主要通过Carla.cpp文件中的StartupModule和ShutdownModule方法实现，这两个方法定义了插件的生命周期管理。

### StartupModule方法

StartupModule方法在插件加载时被调用，负责初始化插件所需的各种资源和设置：

```cpp
void FCarlaModule::StartupModule()
{
    RegisterSettings();
    LoadChronoDll();
}
```

该方法主要执行两个关键操作：

1. **RegisterSettings()**: 注册插件设置，将UCarlaSettings对象暴露给Unreal Engine的设置系统，使用户可以在编辑器中配置CARLA相关参数。

2. **LoadChronoDll()**: 加载Chrono物理引擎的动态链接库，为车辆物理模拟提供支持。

### ShutdownModule方法

ShutdownModule方法在插件卸载时被调用，负责清理资源和注销设置：

```cpp
void FCarlaModule::ShutdownModule()
{
    if (UObjectInitialized())
    {
        UnregisterSettings();
    }
}
```

该方法确保在插件关闭时正确注销之前注册的设置，避免内存泄漏和资源冲突。

### 设置注册机制

RegisterSettings方法实现了详细的设置注册逻辑：

```cpp
void FCarlaModule::RegisterSettings()
{
    if (ISettingsModule* SettingsModule = FModuleManager::GetModulePtr<ISettingsModule>("Settings"))
    {
        ISettingsContainerPtr SettingsContainer = SettingsModule->GetContainer("Project");
        
        SettingsContainer->DescribeCategory("CARLASettings",
            LOCTEXT("RuntimeWDCategoryName", "CARLA Settings"),
            LOCTEXT("RuntimeWDCategoryDescription", "CARLA plugin settings"));
            
        ISettingsSectionPtr SettingsSection = SettingsModule->RegisterSettings("Project", "CARLASettings", "General",
            LOCTEXT("RuntimeGeneralSettingsName", "General"),
            LOCTEXT("RuntimeGeneralSettingsDescription", "General configuration for the CARLA plugin"),
            GetMutableDefault<UCarlaSettings>()
        );
        
        if (SettingsSection.IsValid())
        {
            SettingsSection->OnModified().BindRaw(this, &FCarlaModule::HandleSettingsSaved);
        }
    }
}
```

这个机制将UCarlaSettings类的实例注册到项目设置中，创建名为"CARLASettings"的类别，并设置修改回调函数。

```mermaid
sequenceDiagram
participant Engine as Unreal Engine
participant Module as FCarlaModule
participant Settings as SettingsModule
Engine->>Module : Load Plugin
Module->>Module : StartupModule()
Module->>Module : RegisterSettings()
Module->>Settings : GetContainer("Project")
Settings-->>Module : Container
Module->>Settings : DescribeCategory("CARLASettings")
Module->>Settings : RegisterSettings()
Settings-->>Module : SettingsSection
Module->>Module : Bind OnModified callback
Module-->>Engine : Initialization Complete
Engine->>Module : Unload Plugin
Module->>Module : ShutdownModule()
Module->>Module : UnregisterSettings()
Module-->>Engine : Cleanup Complete
```

**图示来源**
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [Carla.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.h)

**本节来源**
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [Carla.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.h)

## 自定义CARLA插件创建指南

创建自定义CARLA插件需要遵循特定的目录结构和配置流程。以下是详细的分步指南：

### 目录结构创建

首先创建符合Unreal Engine插件规范的目录结构：

```
MyCarlaPlugin/
├── Config/
│   └── DefaultConfig.ini
├── Content/
├── Source/
│   └── MyCarlaPlugin/
│       ├── MyCarlaPlugin.Build.cs
│       ├── MyCarlaPlugin.h
│       └── MyCarlaPlugin.cpp
└── MyCarlaPlugin.uplugin
```

### .uplugin文件配置

创建MyCarlaPlugin.uplugin文件，配置插件基本信息和模块：

```json
{
  "FileVersion": 3,
  "Version": 1,
  "VersionName": "1.0.0",
  "FriendlyName": "My CARLA Plugin",
  "Description": "Custom plugin for CARLA simulation",
  "Category": "Science",
  "CreatedBy": "Your Name",
  "CreatedByURL": "http://yourwebsite.com",
  "DocsURL": "http://yourwebsite.com/docs",
  "SupportURL": "http://yourwebsite.com/support",
  "CanContainContent": true,
  "IsBetaVersion": false,
  "Installed": true,
  "Modules": [
    {
      "Name": "MyCarlaPlugin",
      "Type": "Runtime",
      "LoadingPhase": "PreDefault",
      "AdditionalDependencies": [
        "Engine",
        "Carla"
      ]
    }
  ],
  "Plugins": [
    {
      "Name": "Carla",
      "Enabled": true
    }
  ]
}
```

### 模块类实现

创建MyCarlaPlugin.h和MyCarlaPlugin.cpp文件，实现模块接口：

```cpp
// MyCarlaPlugin.h
#pragma once

#include "CoreMinimal.h"
#include "Modules/ModuleInterface.h"

class FMyCarlaPluginModule : public IModuleInterface
{
public:
    virtual void StartupModule() override;
    virtual void ShutdownModule() override;
};
```

```cpp
// MyCarlaPlugin.cpp
#include "MyCarlaPlugin.h"
#include "MyCarlaPluginSettings.h"

DEFINE_LOG_CATEGORY(LogMyCarlaPlugin);

void FMyCarlaPluginModule::StartupModule()
{
    // 初始化自定义设置
    RegisterSettings();
    
    // 其他初始化代码
    UE_LOG(LogMyCarlaPlugin, Log, TEXT("My CARLA Plugin started successfully"));
}

void FMyCarlaPluginModule::ShutdownModule()
{
    // 清理资源
    if (UObjectInitialized())
    {
        UnregisterSettings();
    }
}
```

### 构建配置

创建MyCarlaPlugin.Build.cs文件，配置编译选项：

```csharp
using UnrealBuildTool;

public class MyCarlaPlugin : ModuleRules
{
    public MyCarlaPlugin(ReadOnlyTargetRules Target) : base(Target)
    {
        PCHUsage = ModuleRules.PCHUsageMode.UseExplicitOrSharedPCHs;
        
        PublicIncludePaths.AddRange(
            new string[] {
                ModuleDirectory
            }
        );
        
        PrivateDependencyModuleNames.AddRange(
            new string[] {
                "Core",
                "CoreUObject",
                "Engine",
                "InputCore",
                "Carla"
            }
        );
    }
}
```

**本节来源**
- [Carla.uplugin](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Carla.uplugin)
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [Carla.Build.cs](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.Build.cs)

## Actor类型和功能接口定义

CARLA插件通过ActorDispatcher系统管理各种Actor类型的创建和注册，实现了灵活的Actor类型定义机制。

### ActorDispatcher系统

ActorDispatcher是CARLA插件中负责Actor创建和管理的核心类，定义在ActorDispatcher.h文件中：

```cpp
UCLASS()
class CARLA_API UActorDispatcher : public UObject
{
    GENERATED_BODY()

public:
    using SpawnFunctionType = TFunction<FActorSpawnResult(const FTransform &, const FActorDescription &)>;
    
    void Bind(FActorDefinition Definition, SpawnFunctionType SpawnFunction);
    void Bind(ACarlaActorFactory &ActorFactory);
    
    TPair<EActorSpawnResultStatus, FCarlaActor*> SpawnActor(
        const FTransform &Transform,
        FActorDescription Description,
        FCarlaActor::IdType DesiredId = 0);
        
    bool DestroyActor(FCarlaActor::IdType ActorId);
    
    FCarlaActor* RegisterActor(
        AActor &Actor,
        FActorDescription ActorDescription,
        FActorRegistry::IdType DesiredId = 0);
        
private:
    TArray<FActorDefinition> Definitions;
    TArray<SpawnFunctionType> SpawnFunctions;
    TArray<TSubclassOf<AActor>> Classes;
    FActorRegistry Registry;
};
```

### Actor类型层次结构

CARLA插件定义了多种Actor类型，通过继承关系组织：

```mermaid
classDiagram
class FCarlaActor {
+IdType Id
+AActor* TheActor
+TSharedPtr<const FActorInfo> Info
+carla : : rpc : : ActorState State
+UWorld* World
+ActorType Type
+TSharedPtr<FActorData> ActorData
}
class FVehicleActor {
+TSharedPtr<FVehicleData> ActorData
}
class FSensorActor {
+TSharedPtr<FActorSensorData> ActorData
}
class FTrafficSignActor {
+TSharedPtr<FTrafficSignData> ActorData
}
class FTrafficLightActor {
+TSharedPtr<FTrafficLightData> ActorData
}
class FWalkerActor {
+TSharedPtr<FWalkerData> ActorData
}
class FOtherActor {
+TSharedPtr<FActorData> ActorData
}
FCarlaActor <|-- FVehicleActor
FCarlaActor <|-- FSensorActor
FCarlaActor <|-- FTrafficSignActor
FCarlaActor <|-- FTrafficLightActor
FCarlaActor <|-- FWalkerActor
FCarlaActor <|-- FOtherActor
```

### Actor创建流程

Actor的创建流程通过SpawnActor方法实现，主要包括以下步骤：

1. 验证ActorDescription的有效性
2. 根据UId查找对应的SpawnFunction
3. 调用SpawnFunction创建Actor实例
4. 注册新创建的Actor到ActorRegistry
5. 返回创建结果

```cpp
TPair<EActorSpawnResultStatus, FCarlaActor*> UActorDispatcher::SpawnActor(
    const FTransform &Transform,
    FActorDescription Description,
    FCarlaActor::IdType DesiredId)
{
    if ((Description.UId == 0u) || (Description.UId > static_cast<uint32>(SpawnFunctions.Num())))
    {
        UE_LOG(LogCarla, Error, TEXT("Invalid ActorDescription '%s' (UId=%d)"), *Description.Id, Description.UId);
        return MakeTuple(EActorSpawnResultStatus::InvalidDescription, nullptr);
    }
    
    UE_LOG(LogCarla, Log, TEXT("Spawning actor '%s'"), *Description.Id);
    
    Description.Class = Classes[Description.UId - 1];
    FActorSpawnResult Result = SpawnFunctions[Description.UId - 1](Transform, Description);
    
    FCarlaActor* View = Result.IsValid() ?
        RegisterActor(*Result.Actor, std::move(Description), DesiredId) : nullptr;
        
    if (!View)
    {
        UE_LOG(LogCarla, Warning, TEXT("Failed to spawn actor '%s'"), *Description.Id);
    }
    else
    {
        ATagger::TagActor(*View->GetActor(), true);
    }
    
    return MakeTuple(Result.Status, View);
}
```

**图示来源**
- [ActorDispatcher.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/ActorDispatcher.h)
- [CarlaActor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/CarlaActor.cpp)

**本节来源**
- [ActorDispatcher.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/ActorDispatcher.h)
- [ActorDispatcher.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/ActorDispatcher.cpp)
- [CarlaActor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/CarlaActor.cpp)

## 插件与Unreal Engine编辑器集成

CARLA插件通过多种机制与Unreal Engine编辑器集成，包括菜单项添加和工具窗口创建。

### 菜单项添加

CarlaExporter插件展示了如何在编辑器中添加菜单项：

```cpp
void FCarlaExporterModule::StartupModule()
{
    FLevelEditorModule& LevelEditorModule = FModuleManager::LoadModuleChecked<FLevelEditorModule>("LevelEditor");
    
    TSharedPtr<FExtender> MenuExtender = MakeShareable(new FExtender());
    MenuExtender->AddMenuExtension("FileActors",
        EExtensionHook::After,
        PluginCommands,
        FMenuExtensionDelegate::CreateRaw(this, &FCarlaExporterModule::AddMenuExtension));
        
    LevelEditorModule.GetMenuExtensibilityManager()->AddExtender(MenuExtender);
}
```

这种方法通过FLevelEditorModule获取编辑器模块，创建菜单扩展器，并将其添加到指定的菜单位置。

### 工具窗口创建

CarlaTools插件提供了编辑器工具的实现：

```cpp
class FCarlaToolsModule : public IModuleInterface
{
public:
    virtual void StartupModule() override;
    virtual void ShutdownModule() override;
};

IMPLEMENT_MODULE(FCarlaToolsModule, CarlaTools)
```

### 命令系统

插件使用Unreal Engine的命令系统来定义可执行操作：

```cpp
class FCarlaExporterCommands : public TCommands<FCarlaExporterCommands>
{
public:
    FCarlaExporterCommands()
        : TCommands<FCarlaExporterCommands>(
            TEXT("CarlaExporter"),
            NSLOCTEXT("Contexts", "CarlaExporter", "CarlaExporter Plugin"),
            NAME_None,
            FEditorStyle::GetStyleSetName())
    {
    }
    
    virtual void RegisterCommands() override;
    
public:
    TSharedPtr< FUICommandInfo > PluginActionExportAll;
};
```

### 编辑器工具Actor

CarlaTools插件还定义了可在编辑器中使用的工具Actor：

```cpp
UCLASS(BlueprintType)
class CARLATOOLS_API AEditorCameraUtils : public AActor
{
    GENERATED_BODY()
public:
    UFUNCTION(BlueprintCallable, CallInEditor)
    void Get();
    
    UFUNCTION(BlueprintCallable, CallInEditor)
    void Set();
    
    UPROPERTY(BlueprintReadWrite, EditAnywhere)
    FTransform CameraTransform;
};
```

这种Actor可以在编辑器中实例化，并通过蓝图或C++调用其方法。

```mermaid
sequenceDiagram
participant Editor as Unreal Editor
participant Module as FCarlaExporterModule
participant LevelEditor as FLevelEditorModule
participant Menu as MenuExtender
Editor->>Module : Initialize Plugin
Module->>Module : StartupModule()
Module->>LevelEditor : Get FLevelEditorModule
LevelEditor-->>Module : Module Reference
Module->>Menu : Create MenuExtender
Menu->>Menu : AddMenuExtension("FileActors")
Module->>LevelEditor : AddExtender()
LevelEditor->>Editor : Update Menu
Editor-->>User : Display New Menu Item
User->>Editor : Click Menu Item
Editor->>Module : Execute Command
Module->>Module : Handle Plugin Action
Module-->>Editor : Update UI
```

**图示来源**
- [CarlaExporter.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Private/CarlaExporter.cpp)
- [CarlaExporterCommands.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Public/CarlaExporterCommands.h)
- [CarlaTools.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaTools/Source/CarlaTools/Public/CarlaTools.h)

**本节来源**
- [CarlaExporter.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Private/CarlaExporter.cpp)
- [CarlaExporterCommands.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaExporter/Source/CarlaExporter/Public/CarlaExporterCommands.h)
- [CarlaTools.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/CarlaTools/Source/CarlaTools/Public/CarlaTools.h)

## 线程安全和内存管理最佳实践

CARLA插件在设计时充分考虑了线程安全和内存管理，为开发者提供了最佳实践参考。

### 内存管理策略

CARLA插件采用智能指针和共享所有权模式来管理内存：

```cpp
TSharedPtr<FCarlaActor> FCarlaActor::ConstructCarlaActor(
    IdType ActorId,
    AActor* Actor,
    TSharedPtr<const FActorInfo> Info,
    ActorType Type,
    carla::rpc::ActorState InState,
    UWorld* World)
{
    switch(Type)
    {
    case ActorType::TrafficSign:
        return MakeShared<FTrafficSignActor>(ActorId, Actor, std::move(Info), InState, World);
    case ActorType::TrafficLight:
        return MakeShared<FTrafficLightActor>(ActorId, Actor, std::move(Info), InState, World);
    case ActorType::Vehicle:
        return MakeShared<FVehicleActor>(ActorId, Actor, std::move(Info), InState, World);
    case ActorType::Walker:
        return MakeShared<FWalkerActor>(ActorId, Actor, std::move(Info), InState, World);
    case ActorType::Sensor:
        return MakeShared<FSensorActor>(ActorId, Actor, std::move(Info), InState, World);
    default:
        return MakeShared<FOtherActor>(ActorId, Actor, std::move(Info), InState, World);
    }
}
```

使用TSharedPtr和MakeShared确保了对象的自动内存管理和线程安全的共享访问。

### 线程安全机制

CARLA插件通过以下机制确保线程安全：

1. **原子操作**: 使用UE4的线程安全原语
2. **锁机制**: 在必要时使用互斥锁保护共享资源
3. **线程局部存储**: 为每个线程维护独立的状态

### 日志系统

插件实现了详细的日志记录机制，便于调试和监控：

```cpp
DEFINE_LOG_CATEGORY(LogCarla);
DEFINE_LOG_CATEGORY(LogCarlaServer);

UE_LOG(LogCarla, Log, TEXT("Spawning actor '%s'"), *Description.Id);
UE_LOG(LogCarla, Warning, TEXT("Failed to spawn actor '%s'"), *Description.Id);
```

### 资源清理

在ShutdownModule中确保所有资源都被正确清理：

```cpp
void FCarlaModule::ShutdownModule()
{
    if (UObjectInitialized())
    {
        UnregisterSettings();
    }
}
```

### 防止内存泄漏

通过NonCopyable基类防止意外的拷贝构造：

```cpp
class NonCopyable {
public:
    NonCopyable() = default;
    NonCopyable(const NonCopyable &) = delete;
    void operator=(const NonCopyable &) = delete;
};
```

这种设计模式确保了对象不会被意外复制，避免了浅拷贝导致的内存泄漏。

```mermaid
flowchart TD
A[内存分配] --> B[使用TSharedPtr]
B --> C[自动引用计数]
C --> D{引用计数为0?}
D --> |是| E[自动释放内存]
D --> |否| F[继续使用]
F --> G[其他线程访问]
G --> C
H[线程安全] --> I[使用原子操作]
H --> J[使用互斥锁]
H --> K[线程局部存储]
L[资源管理] --> M[StartupModule初始化]
M --> N[使用资源]
N --> O[ShutdownModule清理]
O --> P[UnregisterSettings]
```

**图示来源**
- [CarlaActor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/CarlaActor.cpp)
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [NonCopyable.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Util/NonCopyable.h)

**本节来源**
- [CarlaActor.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Actor/CarlaActor.cpp)
- [Carla.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Carla.cpp)
- [NonCopyable.h](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Util/NonCopyable.h)