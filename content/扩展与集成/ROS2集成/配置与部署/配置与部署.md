# 配置与部署


**本文档中引用的文件**  
- [fastrtps-profile.xml](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/config/fastrtps-profile.xml)
- [ros2_native.rviz](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/rviz/ros2_native.rviz)
- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md)
- [ros2_native.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md)
- [ros2_native_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native_sensors.md)
- [ros2_native.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py)
- [run_rviz.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/run_rviz.sh)
- [stack.json](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/stack.json)
- [LibCarla/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/CMakeLists.txt)
- [PythonAPI/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/CMakeLists.txt)
- [Ros2Native/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/Ros2Native/CMakeLists.txt)
- [ROS2.h](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/ROS2.h)
- [ROS2.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/source/carla/ros2/ROS2.cpp)


## 目录
1. [简介](#简介)
2. [环境搭建与部署流程](#环境搭建与部署流程)
3. [DDS QoS策略配置](#dds-qos策略配置)
4. [RViz可视化配置](#rviz可视化配置)
5. [CMake构建系统集成](#cmake构建系统集成)
6. [多机器人仿真网络配置](#多机器人仿真网络配置)
7. [部署检查清单](#部署检查清单)
8. [高级主题：DDS安全与性能调优](#高级主题dds安全与性能调优)
9. [结论](#结论)

## 简介

本文档旨在为用户提供一份关于CARLA与ROS2集成的全面实战指南。文档详细阐述了从环境搭建到系统集成的完整流程，涵盖了fastrtps-profile.xml中DDS QoS策略的配置、RViz可视化配置文件的解析、CMake构建系统如何集成ROS2依赖，以及多机器人仿真的网络配置。此外，文档还为初学者提供了step-by-step的部署检查清单，并为高级用户解释了DDS安全策略和性能调优技巧。

**本文档中引用的文件**  
- [ros2_native.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native.md)
- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md)

## 环境搭建与部署流程

本节将详细介绍如何启动CARLA模拟器并运行ROS2示例，实现传感器数据的发布与可视化。

### 启动CARLA模拟器

要启用CARLA的ROS2原生接口，必须在启动模拟器时添加`--ros2`命令行参数。这将激活服务器端的ROS2功能。

```bash
./CarlaUnreal.sh --ros2
```

### 运行ROS2示例

启动模拟器后，执行Python脚本`ros2_native.py`来创建车辆和传感器。该脚本通过`stack.json`文件定义的配置来设置场景。

```bash
python3 ros2_native.py --file stack.json
```

`stack.json`文件定义了要生成的车辆类型（`vehicle.lincoln.mkz`）及其ID（`hero`），以及两个传感器：一个RGB相机和一个激光雷达。

### 启动RViz进行可视化

为了可视化传感器数据，需要运行`run_rviz.sh`脚本。此脚本使用Docker启动一个包含RViz2的容器，并加载预配置的`ros2_native.rviz`文件。

```bash
./run_rviz.sh
```

该脚本的关键在于通过Docker环境变量`FASTRTPS_DEFAULT_PROFILES_FILE`指定了`fastrtps-profile.xml`配置文件，确保了ROS2通信的正确性。

**本文档中引用的文件**  
- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md)
- [ros2_native.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py)
- [run_rviz.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/run_rviz.sh)
- [stack.json](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/stack.json)

## DDS QoS策略配置

DDS（Data Distribution Service）的QoS（Quality of Service）策略对于确保ROS2通信的可靠性、实时性和效率至关重要。CARLA使用eProsima Fast DDS作为其底层通信中间件，其配置通过`fastrtps-profile.xml`文件进行。

### fastrtps-profile.xml配置解析

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<profiles xmlns="http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles" >
    <transport_descriptors>
        <transport_descriptor>
            <transport_id>CustomUdpTransport</transport_id>
            <type>UDPv4</type>
        </transport_descriptor>
    </transport_descriptors>

    <participant profile_name="participant_profile" is_default_profile="true">
        <rtps>
            <userTransports>
                <transport_id>CustomUdpTransport</transport_id>
            </userTransports>
            <useBuiltinTransports>false</useBuiltinTransports>
        </rtps>
    </participant>

    <publisher profile_name="default publisher profile" is_default_profile="true">
        <qos>
            <publishMode>
                <kind>SYNCHRONOUS</kind>
            </publishMode>
        </qos>
        <historyMemoryPolicy>PREALLOCATED_WITH_REALLOC</historyMemoryPolicy>
    </publisher>
</profiles>
```

#### 关键配置项说明

- **`transport_descriptors`**: 定义了自定义的UDPv4传输。通过`useBuiltinTransports`设为`false`，禁用了内置传输，强制使用自定义的UDP传输，这有助于在复杂网络环境中获得更稳定的连接。
- **`participant`**: 参与者（Participant）是DDS通信的入口点。`is_default_profile="true"`表示此配置为默认配置，所有未明确指定配置的实体都将使用它。
- **`publisher`**: 发布者（Publisher）的QoS配置。
  - **`publishMode.kind`**: 设置为`SYNCHRONOUS`，意味着发布者会等待底层传输确认数据已成功发送，这提高了数据传输的可靠性，但可能增加延迟。
  - **`historyMemoryPolicy`**: 设置为`PREALLOCATED_WITH_REALLOC`，表示为历史数据预分配内存，当数据量超过预分配大小时允许重新分配。这在处理高频率、大数据量的传感器数据（如图像、点云）时，能有效平衡性能和内存使用。

这些配置直接影响通信的可靠性。例如，在自动驾驶仿真中，同步发布模式确保了控制命令和传感器数据不会丢失，而自定义UDP传输则避免了与主机上其他ROS2应用的端口冲突。

**本文档中引用的文件**  
- [fastrtps-profile.xml](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/config/fastrtps-profile.xml)

## RViz可视化配置

RViz是ROS2中用于3D可视化的标准工具。CARLA提供了一个预配置的`ros2_native.rviz`文件，用于直观地显示仿真中的传感器数据和车辆状态。

### ros2_native.rviz配置解析

该文件是一个YAML格式的配置，定义了RViz的窗口布局、显示面板和主题订阅。

#### 核心显示组件

- **TF (Transform)**: 显示坐标系变换。配置中启用了`hero`（车辆）、`lidar`（激光雷达）和`rgb`（相机）的坐标系，并以`hero`为固定参考帧，清晰地展示了传感器相对于车辆的安装位置和姿态。
- **Cameras (相机组)**: 包含一个名为`RGB`的图像显示面板。
  - **Topic**: 订阅`/carla/hero/rgb/image`主题，接收来自ID为`hero`的车辆上的RGB相机的图像数据。
  - **Reliability Policy**: 设置为`Reliable`，确保图像数据包不会丢失。
- **Lidar (激光雷达组)**: 包含一个名为`PointCloud`的点云显示面板。
  - **Topic**: 订阅`/carla/hero/lidar`主题，接收激光雷达的点云数据。
  - **Color Transformer**: 设置为`Intensity`，根据点云的强度信息进行着色。
  - **Style**: 设置为`Flat Squares`，以方形点显示，视觉效果更佳。

#### 坐标系与主题命名规则

RViz中的主题命名遵循CARLA的规则：`/carla/[<PARENT_ROLE_NAME>]/<SENSOR_ROLE_NAME>`。例如，`/carla/hero/rgb/image`表示父级角色名为`hero`的实体（车辆）上的`rgb`传感器发布的图像。这种层次化的命名方式使得在多车辆仿真中能够清晰地区分不同车辆的传感器数据。

**本文档中引用的文件**  
- [ros2_native.rviz](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/rviz/ros2_native.rviz)
- [ros2_native_sensors.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ros2_native_sensors.md)

## CMake构建系统集成

CARLA的构建系统基于CMake，它负责管理复杂的依赖关系，包括ROS2相关的库。

### CMakeLists.txt中的ROS2集成

#### LibCarla模块

在`LibCarla/CMakeLists.txt`中，通过条件编译来集成ROS2功能：
```cmake
if (ENABLE_ROS2)
  file (GLOB LIBCARLA_SERVER_SOURCES_ROS2 ${LIBCARLA_SOURCE_PATH}/carla/ros2/*.cpp)
  list (APPEND LIBCARLA_SERVER_SOURCES ${LIBCARLA_SERVER_SOURCES_ROS2})
  set (CARLA_ROS2_DEFINITIONS WITH_ROS2)
  add_dependencies (carla-server carla-ros2-native)
endif ()
```
当`ENABLE_ROS2`选项被启用时，系统会：
1.  将`carla/ros2/`目录下的所有源文件加入到服务器构建目标中。
2.  定义`WITH_ROS2`宏，使代码中的`#if defined(WITH_ROS2)`条件编译生效。
3.  添加对`carla-ros2-native`目标的依赖，确保ROS2原生库被正确构建。

#### Ros2Native子项目

`Ros2Native/CMakeLists.txt`使用`ExternalProject_add`来管理外部依赖：
```cmake
ExternalProject_add (
  fastdds
  GIT_REPOSITORY https://github.com/eProsima/Fast-DDS.git
  GIT_TAG ${CARLA_FASTDDS_TAG}
  ...
)
```
此配置从指定的Git仓库和标签下载并构建Fast DDS库，实现了对核心DDS中间件的版本控制和自动化集成。

#### Python API构建

`PythonAPI/CMakeLists.txt`通过`carla_add_custom_target`定义了构建Python包的目标，并通过`add_dependencies`确保在构建Python API之前，`carla-client`等C++库已经构建完成。

**本文档中引用的文件**  
- [LibCarla/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/LibCarla/CMakeLists.txt)
- [Ros2Native/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/Ros2Native/CMakeLists.txt)
- [PythonAPI/CMakeLists.txt](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/CMakeLists.txt)

## 多机器人仿真网络配置

在多机器人（多车辆）仿真中，网络配置是确保所有实体能够相互通信的关键。

### IP地址与主机名解析

CARLA的ROS2通信依赖于底层的网络。在Docker环境中运行RViz时，`run_rviz.sh`脚本通过`--net=host`参数让容器共享主机的网络栈，这简化了网络配置，使得容器内的RViz可以直接访问主机上运行的CARLA模拟器。

### 解决通信问题

- **确保端口开放**: CARLA默认使用2000端口进行通信。在多机部署时，需确保防火墙允许该端口的通信。
- **使用正确的主机名/IP**: 在`ros2_native.py`脚本中，可以通过`--host`参数指定CARLA服务器的IP地址。在多机器人场景中，所有客户端都应连接到同一个服务器。
- **统一的fastrtps配置**: 所有参与通信的节点（CARLA服务器、RViz、自定义ROS2节点）应使用相同的`fastrtps-profile.xml`配置，以避免因QoS策略不匹配而导致的通信失败。

**本文档中引用的文件**  
- [run_rviz.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/run_rviz.sh)
- [ros2_native.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py)

## 部署检查清单

为确保部署成功，请遵循以下步骤：

1.  **环境准备**:
    - [ ] 确认已安装Docker。
    - [ ] 确认已安装ROS2 Humble或兼容版本。
    - [ ] 确认CARLA模拟器已正确编译并可运行。

2.  **启动服务**:
    - [ ] 启动CARLA模拟器：`./CarlaUnreal.sh --ros2`。
    - [ ] 运行ROS2示例：`python3 ros2_native.py --file stack.json`。

3.  **验证通信**:
    - [ ] 运行RViz：`./run_rviz.sh`。
    - [ ] 在RViz中检查是否能正常显示车辆的RGB图像和激光雷达点云。
    - [ ] 使用`ros2 topic list`命令检查`/carla/hero/rgb/image`和`/carla/hero/lidar`等主题是否存在。

4.  **高级检查**:
    - [ ] 确认`fastrtps-profile.xml`文件路径正确，并被`run_rviz.sh`脚本正确引用。
    - [ ] 检查`stack.json`文件中的传感器参数（如位置、FOV）是否符合预期。

**本文档中引用的文件**  
- [README.md](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/README.md)
- [run_rviz.sh](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/run_rviz.sh)
- [stack.json](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/stack.json)

## 高级主题：DDS安全与性能调优

### DDS安全策略

Fast DDS支持DDS-Security标准，可实现通信的认证、加密和访问控制。虽然CARLA的默认配置未启用安全功能，但在生产级仿真中，可以通过扩展`fastrtps-profile.xml`来配置安全插件，保护敏感的仿真数据。

### 性能调优技巧

- **调整QoS策略**: 对于实时性要求极高的控制命令，可使用`RELIABLE`可靠性策略和`KEEP_LAST`历史策略，并设置较小的队列深度以减少延迟。对于高带宽的传感器数据，可考虑使用`BEST_EFFORT`策略以避免阻塞。
- **优化fastrtps配置**: 根据网络环境调整传输参数，例如增大UDP缓冲区大小，或在低延迟网络中使用共享内存传输（Shared Memory Transport）。
- **资源监控**: 使用`ros2 topic hz`命令监控主题的发布频率，确保其与仿真步长（`fixed_delta_seconds`）匹配，避免数据积压或丢失。

**本文档中引用的文件**  
- [fastrtps-profile.xml](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/config/fastrtps-profile.xml)
- [ros2_native.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/ros2/ros2_native.py)

## 结论

本文档全面介绍了CARLA与ROS2集成的配置与部署流程。通过理解`fastrtps-profile.xml`中的DDS QoS策略，用户可以优化通信的可靠性和性能。`ros2_native.rviz`文件为传感器数据的可视化提供了开箱即用的解决方案。CMake构建系统的分析揭示了ROS2依赖是如何被无缝集成的。最后，提供的部署检查清单和高级调优技巧，为从初学者到高级用户的不同需求提供了实用的指导。掌握这些知识，将有助于构建稳定、高效的自动驾驶仿真系统。