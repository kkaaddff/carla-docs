# 可视化

> **引用文件**
> **本文档中引用的文件**

- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)
- [visualize_multiple_sensors.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/visualize_multiple_sensors.py)
- [visualize_radar.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/visualize_radar.py)
- [open3d_lidar.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/open3d_lidar.py)
- [show_recorder_file_info.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/show_recorder_file_info.py)
- [start_replaying.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/start_replaying.py)
- [recorder_comparer.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/recorder_comparer.py)
- [generate_video_from_frames.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/tools/generate_video_from_frames.py)
- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md)
- [ref_recorder_binary_file_format.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_recorder_binary_file_format.md)

## 目录

1. [简介](#简介)
2. [CARLA 记录数据结构](#carla记录数据结构)
3. [轨迹可视化](#轨迹可视化)
4. [热力图与传感器数据可视化](#热力图与传感器数据可视化)
5. [时间序列与统计图表](#时间序列与统计图表)
6. [动画演示与回放](#动画演示与回放)
7. [结果导出与分享](#结果导出与分享)
8. [最佳实践建议](#最佳实践建议)

## 简介

CARLA 模拟器提供了强大的记录和回放功能，允许用户记录自动驾驶仿真过程中的所有事件，并通过各种可视化技术进行分析。本指南将详细介绍如何使用 matplotlib、plotly 等库将 CARLA 记录数据分析结果可视化，包括生成车辆轨迹图、热力图、时间序列图表和统计报告。我们将提供代码示例展示如何在二维平面绘制多车辆轨迹，用颜色编码速度或加速度，创建动画演示回放过程，以及生成直方图和散点图等统计图表。此外，还将介绍如何将可视化结果导出为图像或交互式 HTML 文件，便于报告和分享。

## CARLA 记录数据结构

CARLA 记录器将仿真过程中的所有事件保存为自定义的二进制文件格式。这些记录文件包含了创建和销毁的参与者、交通灯状态变化、车辆和行人的位置与方向、线性和角速度、灯光状态以及车辆物理控制等信息。

记录文件的结构包括一个信息头和一系列数据包。信息头包含版本号、标识字符串、记录日期和使用的地图名称等基本信息。数据包则分为多种类型，如帧开始、帧结束、事件添加、事件删除、事件父子关系、碰撞事件、位置信息、交通灯状态、车辆动画和行人动画等。

通过`client.show_recorder_file_info()`方法可以查看记录文件的详细信息，包括记录的帧数、持续时间以及每帧发生的事件。这对于后续的可视化分析至关重要，因为它提供了数据的时间戳和事件类型，为轨迹重建和事件分析奠定了基础。

**Section sources**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md)
- [ref_recorder_binary_file_format.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_recorder_binary_file_format.md)
- [show_recorder_file_info.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/show_recorder_file_info.py)

## 轨迹可视化

在 CARLA 中，可以通过记录文件中的位置数据包（Packet 6 - Position）来重建车辆和行人的运动轨迹。这些数据包记录了场景中所有车辆和行人的位置和方向信息。

使用 matplotlib 进行二维轨迹可视化时，可以从记录文件中提取每个参与者的坐标数据，并在二维平面上绘制其运动路径。为了更好地展示运动状态，可以使用颜色编码来表示速度或加速度。例如，使用从蓝色到红色的渐变色来表示从低速到高速的变化。

```python
import matplotlib.pyplot as plt
import numpy as np

# 假设我们已经从记录文件中提取了轨迹数据
# x, y: 轨迹坐标
# speed: 对应的速度数据

plt.figure(figsize=(12, 8))
sc = plt.scatter(x, y, c=speed, cmap='plasma', s=5)
plt.colorbar(sc, label='速度 (m/s)')
plt.xlabel('X 坐标')
plt.ylabel('Y 坐标')
plt.title('多车辆轨迹可视化')
plt.grid(True)
plt.show()
```

对于多车辆轨迹的可视化，可以为每辆车使用不同的颜色或线型，并添加图例来区分不同的参与者。还可以结合 CARLA 地图信息，在背景上绘制道路网络，使轨迹图更具上下文信息。

**Section sources**

- [ref_recorder_binary_file_format.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_recorder_binary_file_format.md#packet-6-position)
- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)

## 热力图与传感器数据可视化

CARLA 提供了多种传感器，包括 RGB 相机、激光雷达、语义激光雷达和雷达等，这些传感器的数据可以用于生成各种热力图和可视化图表。

激光雷达数据的可视化通常涉及将点云数据投影到二维平面。在`open3d_lidar.py`示例中，展示了如何使用 Open3D 库来可视化激光雷达点云。点云的强度信息可以使用 VIRIDIS 色彩映射进行颜色编码，从而生成直观的热力图。

```python
import open3d as o3d
import numpy as np

# 创建点云对象
point_cloud = o3d.geometry.PointCloud()

# 设置点云坐标和颜色
point_cloud.points = o3d.utility.Vector3dVector(points)
point_cloud.colors = o3d.utility.Vector3dVector(colors)

# 创建可视化器
vis = o3d.visualization.Visualizer()
vis.create_window()
vis.add_geometry(point_cloud)

# 运行可视化
vis.run()
vis.destroy_window()
```

雷达数据的可视化可以通过在 CARLA 世界中绘制点来实现，如`visualize_radar.py`所示。雷达检测到的物体可以根据其相对速度进行颜色编码，通常使用红-绿-蓝色彩方案来表示接近、静止和远离的速度。

对于多传感器数据的可视化，`visualize_multiple_sensors.py`提供了一个完整的框架，可以在同一个 PyGame 窗口中同时显示多个传感器的数据，包括多个摄像头视图、激光雷达和语义激光雷达。

**Section sources**

- [open3d_lidar.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/open3d_lidar.py)
- [visualize_radar.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/visualize_radar.py)
- [visualize_multiple_sensors.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/visualize_multiple_sensors.py)

## 时间序列与统计图表

除了空间可视化，时间序列分析也是理解自动驾驶行为的重要手段。CARLA 记录文件中的数据可以用来生成各种时间序列图表和统计报告。

速度、加速度、转向角等车辆状态参数可以绘制为时间序列图，以分析车辆的动态行为。使用 matplotlib 可以轻松创建这些图表：

```python
import matplotlib.pyplot as plt

# 假设我们有时间、速度和加速度数据
plt.figure(figsize=(12, 6))

plt.subplot(2, 1, 1)
plt.plot(time, speed)
plt.xlabel('时间 (s)')
plt.ylabel('速度 (m/s)')
plt.title('车辆速度时间序列')
plt.grid(True)

plt.subplot(2, 1, 2)
plt.plot(time, acceleration)
plt.xlabel('时间 (s)')
plt.ylabel('加速度 (m/s²)')
plt.title('车辆加速度时间序列')
plt.grid(True)

plt.tight_layout()
plt.show()
```

对于统计分析，可以生成直方图来显示速度分布、加速度分布等。散点图可以用来分析两个变量之间的关系，如速度与转向角的关系。

```python
# 速度分布直方图
plt.figure(figsize=(10, 6))
plt.hist(speed, bins=50, alpha=0.7, color='skyblue', edgecolor='black')
plt.xlabel('速度 (m/s)')
plt.ylabel('频次')
plt.title('车辆速度分布直方图')
plt.grid(True, alpha=0.3)
plt.show()

# 速度与转向角散点图
plt.figure(figsize=(10, 6))
plt.scatter(speed, steering_angle, alpha=0.6)
plt.xlabel('速度 (m/s)')
plt.ylabel('转向角 (rad)')
plt.title('速度与转向角关系散点图')
plt.grid(True, alpha=0.3)
plt.show()
```

这些统计图表有助于识别异常行为、分析驾驶模式和评估自动驾驶算法的性能。

**Section sources**

- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)
- [start_replaying.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/start_replaying.py)

## 动画演示与回放

CARLA 提供了强大的回放功能，可以重现记录的仿真过程。通过`client.replay_file()`方法，可以从指定时间开始回放记录文件，并可选择跟随特定参与者。

```python
# 回放记录文件
client.replay_file("recording01.log", start_time, duration, follow_id)

# 设置回放速度因子
client.set_replayer_time_factor(2.0)  # 2倍速回放
```

为了创建动画演示，可以结合 matplotlib 的动画功能。`matplotlib.animation`模块提供了创建动画的工具，可以将每一帧的可视化状态组合成一个连续的动画。

```python
import matplotlib.pyplot as plt
import matplotlib.animation as animation

fig, ax = plt.subplots(figsize=(12, 8))

def animate(frame):
    ax.clear()
    # 更新当前帧的可视化内容
    # 例如，绘制当前时刻的车辆位置和轨迹
    ax.scatter(x_data[frame], y_data[frame], c='red', s=100)
    ax.plot(x_trajectory[:frame], y_trajectory[:frame], 'b-')
    ax.set_xlim(x_min, x_max)
    ax.set_ylim(y_min, y_max)
    ax.set_title(f'时间: {time[frame]:.2f}s')

ani = animation.FuncAnimation(fig, animate, frames=len(time), interval=50)
plt.show()
```

此外，`generate_video_from_frames.py`工具可以将一系列图像帧合成为视频文件，这对于创建高质量的演示视频非常有用。

**Section sources**

- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)
- [start_replaying.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/start_replaying.py)
- [generate_video_from_frames.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/tools/generate_video_from_frames.py)

## 结果导出与分享

可视化结果可以通过多种方式导出和分享。静态图像可以保存为 PNG、JPEG 等格式，而交互式图表可以导出为 HTML 文件。

```python
# 导出静态图像
plt.savefig('trajectory_plot.png', dpi=300, bbox_inches='tight')
plt.savefig('trajectory_plot.pdf', bbox_inches='tight')  # 矢量图格式

# 使用plotly创建交互式图表并导出为HTML
import plotly.graph_objects as go

fig = go.Figure()
fig.add_trace(go.Scatter(x=x, y=y, mode='lines+markers', name='轨迹'))
fig.update_layout(title='车辆轨迹', xaxis_title='X坐标', yaxis_title='Y坐标')
fig.write_html('interactive_trajectory.html')
```

对于动画，可以导出为 GIF 或视频文件：

```python
# 导出GIF动画
ani.save('animation.gif', writer='pillow', fps=20)

# 导出视频文件
ani.save('animation.mp4', writer='ffmpeg', fps=20)
```

这些导出的文件可以轻松地集成到报告、演示文稿或网页中，便于与团队成员或利益相关者分享分析结果。

**Section sources**

- [generate_video_from_frames.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/tools/generate_video_from_frames.py)

## 最佳实践建议

为了确保可视化图表清晰可读，遵循以下最佳实践建议：

1. **选择合适的色彩方案**：使用色盲友好的色彩方案，避免使用红绿色组合。对于表示数值大小的热力图，使用连续的色彩渐变。

2. **适当的图表尺寸和分辨率**：确保图表足够大，以便清晰显示所有细节。对于出版物，使用高分辨率（如 300dpi）。

3. **清晰的标签和标题**：为所有轴、图例和图表本身提供清晰的标签和描述性标题。使用一致的单位和命名约定。

4. **避免过度拥挤**：当可视化多条轨迹或多组数据时，确保图表不会过于拥挤。可以考虑使用子图或交互式缩放。

5. **提供上下文信息**：在轨迹图中包含地图背景或道路网络，为数据提供空间上下文。

6. **使用交互式可视化**：对于复杂数据集，使用 plotly 等库创建交互式图表，允许用户探索数据的不同方面。

7. **保持一致性**：在整个分析报告中使用一致的颜色编码、符号和样式，以便读者能够轻松比较不同图表。

8. **文档化可视化参数**：记录用于生成每个可视化的参数和设置，以便结果可重现。

遵循这些最佳实践将确保您的可视化结果不仅美观，而且信息丰富、易于理解，能够有效地传达分析发现。

**Section sources**

- [visualize_multiple_sensors.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/visualize_multiple_sensors.py)
- [open3d_lidar.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/open3d_lidar.py)
