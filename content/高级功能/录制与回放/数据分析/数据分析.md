# 数据分析

> **引用文件**
> **本文档中引用的文件**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md)
- [ref_recorder_binary_file_format.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_recorder_binary_file_format.md)
- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)
- [show_recorder_file_info.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/show_recorder_file_info.py)
- [recorder_comparer.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/recorder_comparer.py)
- [SensorData.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/carla/src/SensorData.cpp)
- [sensor_synchronization.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/sensor_synchronization.py)
- [test_sensor_recording.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/test/API/test_sensor_recording.py)
- [UJsonFileManagerLibrary.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Util/JsonFileManagerLibrary.cpp)

## 目录

1. [简介](#简介)
2. [记录与回放 API](#记录与回放api)
3. [记录文件格式](#记录文件格式)
4. [数据提取与分析](#数据提取与分析)
5. [数据导出功能](#数据导出功能)
6. [与 Python 数据分析库集成](#与python数据分析库集成)
7. [大数据集处理技术](#大数据集处理技术)
8. [实际应用案例](#实际应用案例)
9. [结论](#结论)

## 简介

CARLA 模拟器提供了强大的记录和回放功能，允许用户记录模拟会话并重新播放以进行详细分析。该功能对于自动驾驶系统开发至关重要，因为它使研究人员和开发人员能够捕获模拟中的所有事件，然后仔细检查这些事件以进行调试、验证和性能评估。记录文件捕获了模拟中发生的各种元素，包括参与者（车辆、行人）、交通信号灯状态、传感器读数和事件序列。通过使用回放 API，用户可以提取和分析这些数据，以深入了解模拟行为，识别问题，并验证系统性能。本文档详细介绍了如何使用 CARLA 的记录和回放功能进行数据分析，包括从记录文件中提取 Actor 轨迹、传感器读数和事件序列的方法。

**Section sources**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#recording)

## 记录与回放 API

CARLA 的记录和回放功能通过`carla.Client`类提供的 API 进行管理。记录过程通过`start_recorder`方法启动，该方法需要一个文件名作为参数。默认情况下，记录器仅存储回放模拟所需的必要信息，但可以通过将`additional_data`参数设置为`True`来配置为存储额外数据，包括车辆和行人的线速度和角速度、交通信号灯时间设置、执行时间、参与者的触发和边界框以及车辆的物理控制。

```py
client.start_recorder("/home/carla/recording01.log", True)
```

记录可以通过`stop_recorder`方法停止。回放通过`replay_file`方法启动，该方法需要记录文件的路径以及开始时间、持续时间和要跟随的参与者 ID 等参数。时间因子可以使用`set_replayer_time_factor`方法动态调整，以改变回放速度。时间因子大于 2.0 时，参与者的插值将被禁用，这有助于在快速回放时观察交通流。

```py
client.replay_file("recording01.log", start, duration, camera)
client.set_replayer_time_factor(2.0)
```

**Section sources**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#recording)
- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#simulation-playback)
- [recorder_replay.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/examples/recorder_replay.py)

## 记录文件格式

CARLA 记录文件采用自定义二进制格式，使用小端字节序存储多字节值。文件格式包括一个包含版本、魔法字符串、日期和所用地图等一般信息的小型头部，以及包含不同类型数据包的集合。每个数据包都有一个 5 字节的头部，包含数据包类型 ID 和数据大小。数据包类型包括帧开始、帧结束、参与者创建、参与者销毁、位置、交通信号灯状态等。这种结构允许在回放时跳过不感兴趣的数据包，只需读取头部并跳过数据部分。

记录文件的布局以信息头部开始，后跟按组排列的数据包。每组以帧开始数据包开始，以帧结束数据包结束。帧布局包括事件数据包（如参与者创建和销毁）、位置数据包（记录车辆和行人的位置和方向）和交通信号灯数据包（记录所有交通信号灯的状态）。动画数据包是可选的，但默认情况下会被记录，以确保行人的动画和车辆车轮的方向正确。

**Section sources**

- [ref_recorder_binary_file_format.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/ref_recorder_binary_file_format.md)

## 数据提取与分析

CARLA 提供了多种方法来提取和分析记录数据。`show_recorder_file_info`方法可以检索记录的详细信息，包括地图、日期、时间以及每帧发生的事件。`show_recorder_collisions`方法可以查询记录的碰撞，使用标志过滤涉及的参与者类型（如英雄车辆、其他车辆、行人等）。`show_recorder_actors_blocked`方法可以检测在记录期间被卡住的车辆，通过定义最小移动距离和时间来确定。

```py
print(client.show_recorder_file_info("recording01.log"))
print(client.show_recorder_collisions("recording01.log", "v", "a"))
print(client.show_recorder_actors_blocked("recording01.log", 60, 100))
```

这些查询返回格式化的文本输出，总结了时间、参与者类型、ID 和描述。例如，碰撞查询输出显示碰撞时间、参与者类型和 ID，而被卡住的参与者查询输出按持续时间排序，显示参与者停止移动的时间和持续时间。

**Section sources**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#queries)
- [show_recorder_file_info.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/util/show_recorder_file_info.py)

## 数据导出功能

CARLA 支持将记录数据导出为 CSV、JSON 等分析友好格式。传感器数据对象（如 IMU、GNSS、雷达）具有将信息保存到磁盘的方法。例如，IMU 传感器数据可以保存为 CSV 文件，包含帧号、加速度计、陀螺仪和罗盘读数。GNSS 数据可以保存为 JSON 文件，包含高度、纬度、经度和帧号。雷达数据也可以保存为 JSON 文件，包含速度、方位角、高度和深度。

```py
IMUSensor.save_to_csv(weak_self)
UJsonFileManagerLibrary::SaveGnssDataToJson(JsonFilePath, Altitude, Latitude, Longitude, FrameNumber)
UJsonFileManagerLibrary::SaveRadarDataToJson(JsonFilePath, Rays, FrameNumber)
```

这些导出功能允许将 CARLA 数据与外部分析工具集成，便于使用 pandas、matplotlib 等 Python 库进行深入分析。

**Section sources**

- [test_sensor_recording.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/test/API/test_sensor_recording.py)
- [UJsonFileManagerLibrary.cpp](https://github.com/carla-simulator/carla/blob/ue5-dev/Unreal/CarlaUnreal/Plugins/Carla/Source/Carla/Util/JsonFileManagerLibrary.cpp)

## 与 Python 数据分析库集成

CARLA 记录数据可以与 Python 数据分析库（如 pandas 和 matplotlib）无缝集成。导出的 CSV 和 JSON 文件可以使用 pandas 加载到 DataFrame 中，便于进行数据操作、过滤和统计分析。例如，可以使用 pandas 计算车辆的平均速度、加速度或行驶距离。matplotlib 可以用于生成可视化图表，如车辆轨迹图、速度随时间变化图或传感器读数热图。

```py
import pandas as pd
import matplotlib.pyplot as plt

# 加载IMU数据
imu_data = pd.read_csv('imu_data.csv')
# 绘制加速度计数据
plt.plot(imu_data['frame'], imu_data['accelerometer'])
plt.xlabel('帧')
plt.ylabel('加速度计')
plt.title('IMU加速度计读数')
plt.show()
```

这种集成使得对 CARLA 模拟数据进行复杂分析成为可能，帮助研究人员和开发人员从数据中获得有价值的见解。

**Section sources**

- [test_sensor_recording.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/test/API/test_sensor_recording.py)

## 大数据集处理技术

处理大型 CARLA 记录数据集时，内存优化和并行分析至关重要。可以使用分块技术将大型 CSV 文件分块读取到 pandas DataFrame 中，以减少内存占用。并行处理可以通过 multiprocessing 库实现，将数据分析任务分配到多个 CPU 核心上。此外，可以使用 Dask 等库进行分布式计算，处理超出单机内存限制的大型数据集。

```py
# 分块读取大型CSV文件
chunk_iter = pd.read_csv('large_file.csv', chunksize=1000)
for chunk in chunk_iter:
    # 处理每个数据块
    process_chunk(chunk)
```

这些技术确保了即使面对大型模拟数据集，也能高效地进行数据分析。

**Section sources**

- [test_sensor_recording.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/test/API/test_sensor_recording.py)

## 实际应用案例

CARLA 记录数据分析在实际应用中具有广泛用途。碰撞分析可以通过回放碰撞事件并检查相关参与者的轨迹和传感器读数来完成。路径规划评估可以通过比较规划路径与实际行驶路径来完成，使用 pandas 计算偏差和效率指标。传感器性能验证可以通过分析传感器读数（如雷达点云或摄像头图像）与地面实况数据的对比来完成。

```py
# 碰撞分析
collision_data = client.show_recorder_collisions("recording01.log", "v", "a")
# 路径规划评估
planned_path = load_planned_path()
actual_path = extract_actor_trajectory("vehicle_id")
# 传感器性能验证
radar_data = load_radar_data()
ground_truth = load_ground_truth()
```

这些案例展示了 CARLA 记录数据分析在自动驾驶系统开发和验证中的强大功能。

**Section sources**

- [adv_recorder.md](https://github.com/carla-simulator/carla/blob/ue5-dev/Docs/adv_recorder.md#queries)
- [test_sensor_recording.py](https://github.com/carla-simulator/carla/blob/ue5-dev/PythonAPI/test/API/test_sensor_recording.py)

## 结论

CARLA 的记录和回放功能为模拟数据分析提供了强大的工具集。通过使用回放 API，用户可以提取和分析参与者轨迹、传感器读数和事件序列。数据导出功能支持将记录数据转换为 CSV、JSON 等格式，便于与 Python 数据分析库集成。内存优化和并行分析技术使得处理大型数据集成为可能。实际应用案例，如碰撞分析、路径规划评估和传感器性能验证，展示了这些功能在自动驾驶系统开发中的重要价值。通过充分利用 CARLA 的数据分析能力，研究人员和开发人员可以更深入地理解模拟行为，加速开发过程，并提高系统性能。
